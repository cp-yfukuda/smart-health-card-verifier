{"version":3,"names":["jose","fetchWithTimeout","ErrorCode","SHLError","ManifestContentTypeEnum","requestedOrigin","JWS_FETCH_TIMEOUT","SMARTDataLoader","constructor","key","manifestFileInfo","_defineProperty","rawBundles","load","shlFiles","files","keyBuffer","util","base64url","decode","console","info","i","contentType","isKnownContent","shlEncrypted","fetchSHLContent","keyStore","keys","kty","use","alg","k","ks","JWK","asKeyStore","decrypter","JWE","createDecrypt","decrypted","decrypt","shlJson","JSON","parse","payload","toString","verifiableCredential","j","pushSHC","resourceType","pushRawBundle","e","error","data","verifiableCredentials","push","fhir","fetchJWS","shlURL","responseRaw","headers","Origin","catch","_","SHL_JWS_RETRIEVAL_ERROR","file","embedded","Promise","resolve","response","location","text","SHC_CONTENTTYPE","FHIR_CONTENTTYPE","INFER_CONTENTTYPE","init"],"sources":["SMARTDataLoader.ts"],"sourcesContent":["import type { FHIRBundleType } from 'parser-sdk'\n//import { KeysStore } from 'jws-utils'\nimport type { ManifestItemType,  ManifestType } from './types'\nimport jose from 'node-jose'\nimport { fetchWithTimeout } from './utils/utils'\nimport { ErrorCode, SHLError} from './errors'\n\nenum ManifestContentTypeEnum {\n    SHC_CONTENTTYPE = 'application/smart-health-card',\n    FHIR_CONTENTTYPE = 'application/fhir+json',\n    INFER_CONTENTTYPE = '___INFER___'\n};\n\nconst requestedOrigin = 'https://example.org'; // request bogus origin to test CORS response\nconst JWS_FETCH_TIMEOUT = 5000;\nclass SMARTDataLoader {\n    key: string\n    verifiableCredentials: any[] = [];\n    rawBundles: FHIRBundleType[]\n    manifestFileInfo: ManifestType\n    constructor( key: string, manifestFileInfo: ManifestType ) {\n        this.key = key;\n        this.rawBundles = [];\n        this.manifestFileInfo = manifestFileInfo;\n    }\n\n    async load(): Promise<FHIRBundleType[]>{\n\n\n        try {\n\n          const shlFiles = this.manifestFileInfo.files;\n\n          const keyBuffer = jose.util.base64url.decode(this.key);\n          console.info(\"#YF keyBuffer = \" + keyBuffer )\n          for (const i in shlFiles) {\n\n            const contentType = shlFiles[i].contentType;\n\n            if( ! this.isKnownContent( contentType ) ) {\n                continue;\n            }\n            const shlEncrypted = await this.fetchSHLContent(shlFiles[i]);\n            // KeysStore.resetStore();\n\n            const keyStore = { keys: [{\n                kty: 'oct',\n                use: 'enc',\n                alg: 'A256GCM',\n                k: keyBuffer\n            }] };\n\n            const ks = await jose.JWK.asKeyStore(keyStore)\n            const decrypter = await jose.JWE.createDecrypt(ks);\n            const decrypted =  await decrypter.decrypt(shlEncrypted)\n\n            // const decrypted = await jose.JWE.createDecrypt(keyBuffer)\n            //                             .decrypt(shlEncrypted);\n            // var decrypter = jose.JWE.createDecrypt(this.key);\n            // const decrypted =  decrypter.decrypt(shlEncrypted)\n            const shlJson = JSON.parse(decrypted.payload.toString(\"utf8\"),);\n            console.info(\"#YF data =======\")\n            console.info(shlJson)\n        //    #TODO support SHL in case of SHC\n            if (shlJson.verifiableCredential) {\n              // looks like an shc to me\n              for (const j in shlJson.verifiableCredential) {\n                this.pushSHC(shlJson.verifiableCredential[j]);\n              }\n            } else if (shlJson.resourceType) {\n              this.pushRawBundle(shlJson);\n            }\n          }\n\n        } catch ( e ) {\n            console.error(`#YF Error decrypting ${e}`)\n\n        }\n        return this.rawBundles\n\n    }\n\n    pushSHC( data ) {\n        this.verifiableCredentials.push( data )\n    }\n\n    pushRawBundle( fhir ) {\n  \n      if (fhir.resourceType === \"Bundle\") {\n        // already a bundle\n        this.rawBundles.push(fhir);\n      }\n      else {\n        // put it into a bundle\n        this.rawBundles.push({\n          \"resourceType\": \"Bundle\",\n          \"type\": \"collection\",\n          \"entry\": [ {\n            \"fullUrl\": \"resource:0\",\n            \"resource\": fhir\n          } ]\n        });\n      }\n    }\n\n    async fetchJWS( shlURL: string): Promise<Response>{\n        const responseRaw = await fetchWithTimeout(shlURL, {\n        headers: {\n            Origin: requestedOrigin\n          }\n        }, JWS_FETCH_TIMEOUT, \"ERROR Fetching JWS\").catch(_ => {\n          throw new SHLError(ErrorCode.SHL_JWS_RETRIEVAL_ERROR);\n        });\n        return responseRaw;\n    }\n\n    async fetchSHLContent( file: ManifestItemType ) {\n      if (file.embedded) return Promise.resolve(file.embedded);\n      const response = await this.fetchJWS(file.location!);\n      return(response.text());\n    }\n\n    isKnownContent( contentType: string  ) {\n        if (contentType === ManifestContentTypeEnum.SHC_CONTENTTYPE ||\n            contentType === ManifestContentTypeEnum.FHIR_CONTENTTYPE ||\n            contentType === ManifestContentTypeEnum.INFER_CONTENTTYPE) {\n          return true;\n        }\n        return false;\n    }\n\n    static init( key: string, manifestFileInfo: ManifestType  ) {\n        return new SMARTDataLoader( key, manifestFileInfo )\n\n    }\n}\n\nexport default SMARTDataLoader;"],"mappings":"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"}