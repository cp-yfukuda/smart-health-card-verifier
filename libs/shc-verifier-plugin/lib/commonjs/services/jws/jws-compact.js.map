{"version":3,"names":["JwsValidationOptions","skipJwksDownload","jwksDownloadTimeOut","MAX_JWS_SINGLE_CHUNK_LENGTH","validate","jws","KeysStore","resetStore","trim","console","log","ErrorCode","TRAILING_CHARACTERS","length","JWS_TOO_LONG","jwsRegex","isJws","test","JSON_PARSE_ERROR","validateSchema","jwsCompactSchema","header","rawPayload","key","split","headerJson","checkJwsHeader","checkJwsSignatureFormat","inflatedPayload","b64DecodedPayloadString","checkJwsPayload","join","isJwsPayloadValid","jwsPayload","err","payload","Utils","parseJson","extractKeyURL","InvalidError","result","isValid","verifyJws","kid","document","getRecord","fetchWithTimeout","url","options","timeout","timeoutError","Promise","race","fetch","_","reject","setTimeout","Error","downloadAndImportValidKeys","issuerURL","timer","Timer","jwkURL","requestedOrigin","start","responseRaw","headers","Origin","catch","ISSUER_KEY_DOWNLOAD_ERROR","keySet","json","loadingTime","stop","toFixed","verifyAndImportHealthCardIssuerKey","String","message","headerBytes","errString","Buffer","from","JWS_VERIFICATION_ERROR","toString","JWS_HEADER_ERROR","headerKeys","Object","keys","includes","alg","zip","sigBytes","SIGNATURE_FORMAT_ERROR","rStart","rBytes","slice","sStart","sBytes","newSig","concat","replace","b64DecodedPayloadBuffer","pako","inflateRaw","to","inflate","INFLATION_ERROR","iss","INVALID_ISSUER_URL","useLegacy","getVerifierInitOption","getIssuerFunc","getIssuer","VerifierKey","store","get","error","verifier","jose","JWS","createVerify","verify"],"sources":["jws-compact.ts"],"sourcesContent":["/* eslint no-catch-shadow: off, no-shadow: off */\nimport pako from 'pako'\nimport jose from 'react-native-jose'\n\nimport { InvalidError, Utils, Timer } from 'verifier-sdk'\nimport type { JWSPayload } from '../fhir/types'\nimport { ErrorCode } from 'verifier-sdk'\nimport { getVerifierInitOption, VerifierKey } from '../../models/Config'\nimport { KeysStore } from './keys'\nimport * as jwsPayload from './jws-payload'\nimport { validateSchema } from './schema'\nimport jwsCompactSchema from '../../schemas/jws-schema.json'\nimport { verifyAndImportHealthCardIssuerKey } from './shcKeyValidator'\nimport { getRecord } from '../fhir/fhirBundle'\nexport const JwsValidationOptions = {\n  skipJwksDownload: false,\n  jwksDownloadTimeOut: 5000,\n}\n\nconst MAX_JWS_SINGLE_CHUNK_LENGTH = 1195\n\nexport async function validate ( jws: string ): Promise<any> {\n  KeysStore.resetStore()\n  if (jws.trim() !== jws) {\n    console.log('JWS has leading or trailing spaces', ErrorCode.TRAILING_CHARACTERS)\n    jws = jws.trim()\n  }\n  if (jws.length > MAX_JWS_SINGLE_CHUNK_LENGTH) {\n    console.log(\n      `JWS is longer than ${MAX_JWS_SINGLE_CHUNK_LENGTH} characters, and will result in split QR codes`,\n      ErrorCode.JWS_TOO_LONG,\n    )\n  }\n\n  const jwsRegex = /[0-9a-zA-Z_-]+\\.[0-9a-zA-Z_-]+\\.[0-9a-zA-Z_-]+/g\n  const isJws = jwsRegex.test(jws)\n  if (!isJws) {\n    console.log(\n      \"Failed to parse JWS-compact data as 'base64url.base64url.base64url' string.\",\n      ErrorCode.JSON_PARSE_ERROR,\n    )\n    return false\n  }\n\n  // failures will be recorded in the console.logan continue processing.\n  validateSchema(jwsCompactSchema, jws)\n\n  // split jws into header, payload, key\n  let [header, rawPayload, key] = jws.split('.')\n  const headerJson = checkJwsHeader(header)\n  key = checkJwsSignatureFormat(key)\n  const { inflatedPayload, b64DecodedPayloadString } = checkJwsPayload(rawPayload)\n\n  jws = [header, rawPayload, key].join('.')\n\n  try {\n    const isJwsPayloadValid = await jwsPayload.validate(\n      inflatedPayload || b64DecodedPayloadString || rawPayload,\n    )\n    if (!isJwsPayloadValid) {\n      console.log('ERROR at jwsPayload.validate!')\n    }\n  }catch (err) {\n    console.log('ERROR at jwsPayload.validate!')\n    //#TODO throw error? \n  }\n  // try to parse JSON even if it failed validation above\n  // if we did not get a payload back, it failed to be parsed and we cannot extract the key url\n  // so we can stop. The jws-payload child will contain the parse errors.\n  // The payload validation may have a Fatal error\n  const payload = Utils.parseJson<JWSPayload>(inflatedPayload || b64DecodedPayloadString || rawPayload)\n  if (!payload) {\n    console.log('NO PAYLOAD!!')\n    return\n  }\n\n  try { \n    await extractKeyURL(payload)\n  } catch (err) {\n    if (err instanceof InvalidError) throw err\n    return \n  }\n  const result = false\n  if (!headerJson) {\n    return result\n  }\n\n  const isValid = await verifyJws(jws, headerJson.kid)\n  let document = await getRecord( payload, headerJson)\n\n  document = {\n    isValid,\n    ...document\n  }\n\n  return document\n}\n\nasync function fetchWithTimeout (url: string, options: any, timeout: number, timeoutError: string) {\n  return await Promise.race([\n    fetch(url, options),\n\n    new Promise((_:any, reject) => setTimeout(() => reject(new Error(timeoutError)), timeout)),\n  ])\n}\n\nasync function downloadAndImportValidKeys (issuerURL: string ): Promise<boolean> {\n  const timer = new Timer()\n  const jwkURL = issuerURL + '/.well-known/jwks.json'\n  const requestedOrigin = 'https://example.org' // request bogus origin to test CORS response\n\n  const timeoutError = 'Failed to download issuer JWK set'\n  const timeout = JwsValidationOptions.jwksDownloadTimeOut\n  try {\n    timer.start()\n    const responseRaw: any = await fetchWithTimeout(\n      jwkURL,\n      { headers: { Origin: requestedOrigin } },\n      timeout,\n      timeoutError,\n    ).catch( ( _:any )=> {\n      throw new InvalidError( ErrorCode.ISSUER_KEY_DOWNLOAD_ERROR )\n    })\n    const keySet = await responseRaw.json()\n    let loadingTime = timer.stop()\n    console.log(`loading issure key: ${loadingTime.toFixed(2)}sec`)\n    if (!keySet) {\n      throw new Error('Failed to parse JSON KeySet schema')\n    }\n\n    try {\n      timer.start()\n      await verifyAndImportHealthCardIssuerKey(keySet)\n      loadingTime = timer.stop()\n      console.log(`verification took:  ${loadingTime.toFixed(2)}sec`)\n\n      return true\n    } catch ( err : any ) {\n      console.log(\n        `Can't parse downloaded issuer JWK set: ${String(err.message)}`,\n        ErrorCode.ISSUER_KEY_DOWNLOAD_ERROR,\n      )\n      return false\n    }\n  } catch (err: any) {\n    if ( err instanceof InvalidError ) throw err\n    console.log(\n      `Failed to download issuer JWK set:  ${String(err.message)}`,\n      ErrorCode.ISSUER_KEY_DOWNLOAD_ERROR,\n    )\n    // return undefined\n\n    throw new Error(timeoutError)\n  }\n}\n\nfunction checkJwsHeader (header: string) {\n  let headerBytes\n  let errString\n\n  try {\n    headerBytes = Buffer.from(header, 'base64')\n  } catch (err) {\n    errString = err as string\n  } finally {\n    if (!headerBytes) {\n      console.log(\n        ['Error base64-decoding the JWS header.', errString].join('\\n'),\n        ErrorCode.JWS_VERIFICATION_ERROR,\n      )\n    }\n  }\n\n  let headerJson\n\n  if (headerBytes) {\n    headerJson = Utils.parseJson<{ kid: string, alg: string, zip: string }>(headerBytes.toString())\n    if (headerJson == null) {\n      console.log(\n        [\"Can't parse JWS header as JSON.\", errString].join('\\n'),\n        ErrorCode.JWS_HEADER_ERROR,\n      )\n    } else {\n      const headerKeys = Object.keys(headerJson)\n\n      if (!headerKeys.includes('alg')) {\n        console.log(\"JWS header missing 'alg' property.\", ErrorCode.JWS_HEADER_ERROR)\n      } else if (headerJson.alg !== 'ES256') {\n        console.log(\n          `Wrong value for JWS header property 'alg' property expected: \"ES256\", actual: \"${headerJson.alg}\".`,\n          ErrorCode.JWS_HEADER_ERROR,\n        )\n      }\n      if (!headerKeys.includes('zip')) {\n        console.log(\"JWS header missing 'zip' property.\", ErrorCode.JWS_HEADER_ERROR)\n      } else if (headerJson.zip !== 'DEF') {\n        console.log(\n          `Wrong value for JWS header property 'zip' property expected: \"DEF\", actual: \"${headerJson.zip}\".`,\n          ErrorCode.JWS_HEADER_ERROR,\n        )\n      }\n      if (!headerKeys.includes('kid')) {\n        console.log(\"JWS header missing 'kid' property.\", ErrorCode.JWS_HEADER_ERROR)\n      }\n\n      // the value of the kid will be used in the crypto validation of the signature to select the issuer's public key\n    }\n  }\n\n  return headerJson\n}\n\nfunction checkJwsSignatureFormat (key: string) {\n  let sigBytes\n  try {\n    sigBytes = Buffer.from(key, 'base64')\n  } catch (err) {\n    console.log(\n      ['Error base64-decoding the JWS signature.', err as string].join('\\n'),\n      ErrorCode.JWS_VERIFICATION_ERROR,\n    )\n  }\n\n  if (sigBytes && sigBytes.length > 64 && sigBytes[0] === 0x30 && sigBytes[2] === 0x02) {\n    console.log(\n      'Signature appears to be in DER encoded form. Signature is expected to be 64-byte r||s concatenated form.\\n' +\n        'See https://tools.ietf.org/html/rfc7515#appendix-A.3 for expected ES256 signature form.',\n      ErrorCode.SIGNATURE_FORMAT_ERROR,\n    )\n\n    // DER encoded signature will constructed as follows:\n    // 0       |1             |2      |3         |4-35             |36       |37        |38-69\n    // 0x30      |0x44          |0x02     |0x20        |<r-component of signature> |0x02     |0x20 or 0x21    |<s-component of signature>\n    // Sequence-type |length-of-sequence-data |Integer-type |length-of-integer |integer-data         |Integer-type |length-of-integer |integer-data\n\n    // sigBytes[3] contains length of r-integer it may be 32 or 33 bytes.\n    // DER encoding dictates an Integer is negative if the high-order bit of the first byte is set.\n    //   To represent an integer with a high-order bit as positive, a leading zero byte is required.\n    //   This increases the Integer length to 33.\n\n    // For signature use, the sign is irrelevant and the leading zero, if present, is ignored.\n    const rStart = 4 + (sigBytes[3] - 32) // adjust for the potential leading zero\n    const rBytes = sigBytes.slice(rStart, rStart + 32) // 32 bytes of the r-integer\n    const sStart = sigBytes.length - 32\n    const sBytes = sigBytes.slice(sStart) // 32 bytes of the s-integer\n\n    // Make Base64url\n    const newSig = Buffer.concat([rBytes, sBytes])\n      .toString('base64')\n      .replace(/\\+/g, '-')\n      .replace(/\\//g, '_')\n      .replace(/[=]/g, '')\n    key = newSig\n\n    console.log('jws-signature converted from DER form to r||s form: ' + newSig)\n  } else if (sigBytes && sigBytes.length !== 64) {\n    console.log(\n      'Signature is ' + sigBytes.length.toString() + '-bytes. Signature is expected to be 64-bytes',\n      ErrorCode.SIGNATURE_FORMAT_ERROR,\n    )\n  }\n  return key\n}\n\nfunction checkJwsPayload (rawPayload: string) {\n  // check payload\n  let b64DecodedPayloadBuffer\n  let b64DecodedPayloadString\n\n  try {\n    b64DecodedPayloadBuffer = Buffer.from(rawPayload, 'base64')\n  } catch (err) {\n    console.log(\n      ['Error base64-decoding the JWS payload.', err as string].join('\\n'),\n      ErrorCode.JWS_VERIFICATION_ERROR,\n    )\n  }\n\n  let inflatedPayload\n\n  if (b64DecodedPayloadBuffer) {\n    try {\n      inflatedPayload = pako.inflateRaw(b64DecodedPayloadBuffer, { to: 'string' }).trim()\n    } catch (err) {\n      // try normal inflate\n      try {\n        inflatedPayload = pako.inflate(b64DecodedPayloadBuffer, { to: 'string' }).trim()\n        console.log(\n          'Error inflating JWS payload. Compression should use raw DEFLATE (without wrapper header and adler32 crc)',\n          ErrorCode.INFLATION_ERROR,\n        )\n      } catch (err) {\n        console.log(\n          ['Error inflating JWS payload. Did you use raw DEFLATE compression?', err as string].join(\n            '\\n',\n          ),\n          ErrorCode.INFLATION_ERROR,\n        )\n        // inflating failed, let's try to parse the base64-decoded string directly\n        b64DecodedPayloadString = b64DecodedPayloadBuffer.toString('utf-8').trim()\n      }\n    }\n  }\n  return { inflatedPayload, b64DecodedPayloadString }\n}\n\nasync function extractKeyURL (payload: any) {\n  if (payload.iss) {\n    if (typeof payload.iss === 'string') {\n      if (payload.iss.slice(0, 8) !== 'https://') {\n        console.log('Issuer URL SHALL use https', ErrorCode.INVALID_ISSUER_URL)\n      }\n\n      if (payload.iss.slice(-1) === '/') {\n        console.log('Issuer URL SHALL NOT include a trailing /', ErrorCode.INVALID_ISSUER_URL)\n      }\n      // from issuer data in the vci directory, look for issuer data.\n      var iss= payload.iss\n      var useLegacy = getVerifierInitOption().useLegacy\n      if( ! useLegacy  ) {\n         //switch to canonical_iss if there is \n         var getIssuerFunc = getVerifierInitOption().getIssuer\n         iss = await getIssuerFunc( VerifierKey, payload.iss ) ?? payload.iss\n      }\n      // download the keys into the keystore. if it fails, continue an try to use whatever is in the keystore.\n      if (!JwsValidationOptions.skipJwksDownload) {\n\n        await downloadAndImportValidKeys( iss )\n      } else {\n        console.log('skipping issuer JWK set download')\n      }\n    } else {\n      console.log(`JWS payload 'iss' should be a string, not a ${typeof payload.iss}`)\n    }\n  } else {\n    throw new Error(\"Can't find 'iss' entry in JWS payload\")\n  }\n}\n\nasync function verifyJws (jws: string, kid: string): Promise<boolean> {\n  var key: any | null = null;\n  if (kid && ! ( key = KeysStore.store.get(kid))) {\n    console.log(\n      `JWS verification failed: can't find key with 'kid' = ${kid} in issuer set`,\n      ErrorCode.JWS_VERIFICATION_ERROR,\n    )\n  }\n  if( key && key.error && key.error instanceof InvalidError ) {\n    throw key.error\n  }\n  const verifier: jose.JWS.Verifier = jose.JWS.createVerify(KeysStore.store)\n\n  try {\n    const result = await verifier.verify(jws)\n    return !!result\n\n  } catch (error) {\n    // The error message is always 'no key found', regardless if a key is missing or\n    // if the signature was tempered with. Don't return the node-jose error message.\n    console.log('JWS verification failed', ErrorCode.JWS_VERIFICATION_ERROR)\n    return false\n  }\n}\n"],"mappings":"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"}