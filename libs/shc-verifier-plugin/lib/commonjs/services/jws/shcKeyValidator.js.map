{"version":3,"names":["_nodeJose","_interopRequireDefault","require","_parserSdk","_keys","obj","__esModule","default","addIfKeyIsValidSHCFormat","key","kid","console","log","ErrorCode","INVALID_KEY_PRIVATE","keyName","String","d","alg","INVALID_KEY_SCHEMA","INVALID_KEY_WRONG_ALG","kty","INVALID_KEY_WRONG_KTY","use","INVALID_KEY_WRONG_USE","jwkKey","KeysStore","store","add","tpDigest","thumbprint","jose","util","base64url","encode","INVALID_KEY_WRONG_KID","error","InvalidError","err","INVALID_KEY_UNKNOWN","verifyAndImportHealthCardIssuerKey","keySet","Object","keys","Array","i","length","debug","message","exports"],"sources":["shcKeyValidator.ts"],"sourcesContent":["import jose, { JWK } from 'node-jose'\nimport { ErrorCode, InvalidError } from 'parser-sdk'\nimport { KeySet, KeysStore } from './keys'\n\nconst addIfKeyIsValidSHCFormat = async ( key: JWK.Key ): Promise< boolean > => {\n  if ( ! key.kid || typeof key.kid !== 'string') {\n    console.log(\n      'key does not contain kid field',\n      ErrorCode.INVALID_KEY_PRIVATE,\n    )\n    return false\n  }\n  const keyName = `key[${String(key.kid)}]`\n\n  // check for private key material (as to happen before the following store.add, because the returned\n  // value will be the corresponding public key)\n  // Note: this is RSA/ECDSA specific, but ok since ECDSA is mandated\n  if ((key as JWK.Key & { d: string }).d) {\n    console.log(\n      `${keyName}: key contains private key material.`,\n      ErrorCode.INVALID_KEY_PRIVATE,\n    )\n    return false\n  }\n  // check that EC curve is 'ES256'\n  if (!key.alg) {\n    console.log(keyName + ': ' + \"'alg' missing in issuer key\", ErrorCode.INVALID_KEY_SCHEMA)\n    return false\n  } else if (key.alg !== 'ES256') {\n    console.log(\n      `${keyName}: wrong algorithm in issuer key. expected: 'ES256', actual: ${String(key.alg)}`,\n      ErrorCode.INVALID_KEY_WRONG_ALG,\n    )\n    return false\n  }\n\n  // check that key type is 'EC'\n  if (!key.kty) {\n    console.log(`${keyName}:'kty' missing in issuer key`, ErrorCode.INVALID_KEY_SCHEMA)\n    return false\n  } else if (key.kty !== 'EC') {\n    console.log(\n      `${keyName}:wrong key type in issuer key. expected: 'EC', actual: ${String( key.kty)} `,\n      ErrorCode.INVALID_KEY_WRONG_KTY,\n    )\n    return false\n  }\n\n  // check that usage is 'sig'\n  if (!key.use) {\n    console.log(`${keyName}:'use' missing in issuer key`, ErrorCode.INVALID_KEY_SCHEMA)\n    return false\n  } else if (key.use !== 'sig') {\n    console.log(\n      `${keyName}:wrong usage in issuer key. expected: 'sig', actual: ${String(key.use)}`,\n      ErrorCode.INVALID_KEY_WRONG_USE,\n    )\n    return false\n  }\n  try {\n    const jwkKey = await KeysStore.store.add(key)\n    const tpDigest: any = await jwkKey.thumbprint('SHA-256')\n    const thumbprint = jose.util.base64url.encode(tpDigest)\n    if (key.kid !== thumbprint) {\n      console.log(\n        `${keyName}:'kid' does not match thumbprint in issuer key. expected: \\\n                    ${String( thumbprint )} , actual: ${String(key.kid)}`,\n        ErrorCode.INVALID_KEY_WRONG_KID,\n      )\n      jwkKey.error = new InvalidError(ErrorCode.INVALID_KEY_WRONG_KID)\n      return false\n    }\n\n  } catch ( err: any ){\n    console.log(\n      `${keyName}: Failed to calculate issuer key thumbprint : ${ err }`,\n      ErrorCode.INVALID_KEY_UNKNOWN,\n    )\n    return false\n  }\n  return true\n}\n\nexport const verifyAndImportHealthCardIssuerKey = async (\n  keySet: KeySet\n): Promise<any> => {\n  // check that keySet is valid\n  if (!(keySet instanceof Object) || !keySet.keys || !(keySet.keys instanceof Array)) {\n    console.log('keySet not valid. Expect {keys : JWK.Key[]}', ErrorCode.INVALID_KEY_SCHEMA)\n    return\n  }\n  for (let i = 0; i < keySet.keys.length; i++) {\n    const key: JWK.Key = keySet.keys[i]\n    try {\n      if ( await addIfKeyIsValidSHCFormat( key ) ) {\n        console.debug(`Key [${String(i)}] added : `)\n      } else {\n        console.debug(`Key [${String(i)}] is not added`)\n      }\n    } catch (error) {\n      console.log(\n        'Error adding key to keyStore : ' + (error as Error).message,\n        ErrorCode.INVALID_KEY_UNKNOWN,\n      )\n    }\n  }\n  \n}\n"],"mappings":";;;;;;AAAA,IAAAA,SAAA,GAAAC,sBAAA,CAAAC,OAAA;AACA,IAAAC,UAAA,GAAAD,OAAA;AACA,IAAAE,KAAA,GAAAF,OAAA;AAA0C,SAAAD,uBAAAI,GAAA,WAAAA,GAAA,IAAAA,GAAA,CAAAC,UAAA,GAAAD,GAAA,KAAAE,OAAA,EAAAF,GAAA;AAE1C,MAAMG,wBAAwB,GAAG,MAAQC,GAAY,IAA0B;EAC7E,IAAK,CAAEA,GAAG,CAACC,GAAG,IAAI,OAAOD,GAAG,CAACC,GAAG,KAAK,QAAQ,EAAE;IAC7CC,OAAO,CAACC,GAAG,CACT,gCAAgC,EAChCC,oBAAS,CAACC,mBAAmB,CAC9B;IACD,OAAO,KAAK;EACd;EACA,MAAMC,OAAO,GAAI,OAAMC,MAAM,CAACP,GAAG,CAACC,GAAG,CAAE,GAAE;;EAEzC;EACA;EACA;EACA,IAAKD,GAAG,CAA6BQ,CAAC,EAAE;IACtCN,OAAO,CAACC,GAAG,CACR,GAAEG,OAAQ,sCAAqC,EAChDF,oBAAS,CAACC,mBAAmB,CAC9B;IACD,OAAO,KAAK;EACd;EACA;EACA,IAAI,CAACL,GAAG,CAACS,GAAG,EAAE;IACZP,OAAO,CAACC,GAAG,CAACG,OAAO,GAAG,IAAI,GAAG,6BAA6B,EAAEF,oBAAS,CAACM,kBAAkB,CAAC;IACzF,OAAO,KAAK;EACd,CAAC,MAAM,IAAIV,GAAG,CAACS,GAAG,KAAK,OAAO,EAAE;IAC9BP,OAAO,CAACC,GAAG,CACR,GAAEG,OAAQ,+DAA8DC,MAAM,CAACP,GAAG,CAACS,GAAG,CAAE,EAAC,EAC1FL,oBAAS,CAACO,qBAAqB,CAChC;IACD,OAAO,KAAK;EACd;;EAEA;EACA,IAAI,CAACX,GAAG,CAACY,GAAG,EAAE;IACZV,OAAO,CAACC,GAAG,CAAE,GAAEG,OAAQ,8BAA6B,EAAEF,oBAAS,CAACM,kBAAkB,CAAC;IACnF,OAAO,KAAK;EACd,CAAC,MAAM,IAAIV,GAAG,CAACY,GAAG,KAAK,IAAI,EAAE;IAC3BV,OAAO,CAACC,GAAG,CACR,GAAEG,OAAQ,0DAAyDC,MAAM,CAAEP,GAAG,CAACY,GAAG,CAAE,GAAE,EACvFR,oBAAS,CAACS,qBAAqB,CAChC;IACD,OAAO,KAAK;EACd;;EAEA;EACA,IAAI,CAACb,GAAG,CAACc,GAAG,EAAE;IACZZ,OAAO,CAACC,GAAG,CAAE,GAAEG,OAAQ,8BAA6B,EAAEF,oBAAS,CAACM,kBAAkB,CAAC;IACnF,OAAO,KAAK;EACd,CAAC,MAAM,IAAIV,GAAG,CAACc,GAAG,KAAK,KAAK,EAAE;IAC5BZ,OAAO,CAACC,GAAG,CACR,GAAEG,OAAQ,wDAAuDC,MAAM,CAACP,GAAG,CAACc,GAAG,CAAE,EAAC,EACnFV,oBAAS,CAACW,qBAAqB,CAChC;IACD,OAAO,KAAK;EACd;EACA,IAAI;IACF,MAAMC,MAAM,GAAG,MAAMC,eAAS,CAACC,KAAK,CAACC,GAAG,CAACnB,GAAG,CAAC;IAC7C,MAAMoB,QAAa,GAAG,MAAMJ,MAAM,CAACK,UAAU,CAAC,SAAS,CAAC;IACxD,MAAMA,UAAU,GAAGC,iBAAI,CAACC,IAAI,CAACC,SAAS,CAACC,MAAM,CAACL,QAAQ,CAAC;IACvD,IAAIpB,GAAG,CAACC,GAAG,KAAKoB,UAAU,EAAE;MAC1BnB,OAAO,CAACC,GAAG,CACR,GAAEG,OAAQ;AACnB,sBAAsBC,MAAM,CAAEc,UAAU,CAAG,cAAad,MAAM,CAACP,GAAG,CAACC,GAAG,CAAE,EAAC,EACjEG,oBAAS,CAACsB,qBAAqB,CAChC;MACDV,MAAM,CAACW,KAAK,GAAG,IAAIC,uBAAY,CAACxB,oBAAS,CAACsB,qBAAqB,CAAC;MAChE,OAAO,KAAK;IACd;EAEF,CAAC,CAAC,OAAQG,GAAQ,EAAE;IAClB3B,OAAO,CAACC,GAAG,CACR,GAAEG,OAAQ,iDAAiDuB,GAAK,EAAC,EAClEzB,oBAAS,CAAC0B,mBAAmB,CAC9B;IACD,OAAO,KAAK;EACd;EACA,OAAO,IAAI;AACb,CAAC;AAEM,MAAMC,kCAAkC,GAAG,MAChDC,MAAc,IACG;EACjB;EACA,IAAI,EAAEA,MAAM,YAAYC,MAAM,CAAC,IAAI,CAACD,MAAM,CAACE,IAAI,IAAI,EAAEF,MAAM,CAACE,IAAI,YAAYC,KAAK,CAAC,EAAE;IAClFjC,OAAO,CAACC,GAAG,CAAC,6CAA6C,EAAEC,oBAAS,CAACM,kBAAkB,CAAC;IACxF;EACF;EACA,KAAK,IAAI0B,CAAC,GAAG,CAAC,EAAEA,CAAC,GAAGJ,MAAM,CAACE,IAAI,CAACG,MAAM,EAAED,CAAC,EAAE,EAAE;IAC3C,MAAMpC,GAAY,GAAGgC,MAAM,CAACE,IAAI,CAACE,CAAC,CAAC;IACnC,IAAI;MACF,IAAK,MAAMrC,wBAAwB,CAAEC,GAAG,CAAE,EAAG;QAC3CE,OAAO,CAACoC,KAAK,CAAE,QAAO/B,MAAM,CAAC6B,CAAC,CAAE,YAAW,CAAC;MAC9C,CAAC,MAAM;QACLlC,OAAO,CAACoC,KAAK,CAAE,QAAO/B,MAAM,CAAC6B,CAAC,CAAE,gBAAe,CAAC;MAClD;IACF,CAAC,CAAC,OAAOT,KAAK,EAAE;MACdzB,OAAO,CAACC,GAAG,CACT,iCAAiC,GAAIwB,KAAK,CAAWY,OAAO,EAC5DnC,oBAAS,CAAC0B,mBAAmB,CAC9B;IACH;EACF;AAEF,CAAC;AAAAU,OAAA,CAAAT,kCAAA,GAAAA,kCAAA"}