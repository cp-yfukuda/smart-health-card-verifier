{"version":3,"names":["addIfKeyIsValidSHCFormat","key","kid","console","log","ErrorCode","INVALID_KEY_PRIVATE","keyName","String","d","alg","INVALID_KEY_SCHEMA","INVALID_KEY_WRONG_ALG","kty","INVALID_KEY_WRONG_KTY","use","INVALID_KEY_WRONG_USE","jwkKey","KeysStore","store","add","tpDigest","thumbprint","jose","util","base64url","encode","INVALID_KEY_WRONG_KID","error","InvalidError","err","message","INVALID_KEY_UNKNOWN","verifyAndImportHealthCardIssuerKey","keySet","Object","keys","Array","i","length","debug"],"sources":["shcKeyValidator.ts"],"sourcesContent":["import jose, { JWK } from 'react-native-jose'\nimport { ErrorCode, InvalidError } from 'verifier-sdk'\nimport { KeySet, KeysStore } from './keys'\n\nconst addIfKeyIsValidSHCFormat = async ( key: JWK.Key ): Promise< boolean > => {\n  if ( ! key.kid || typeof key.kid !== 'string') {\n    console.log(\n      'key does not contain kid field',\n      ErrorCode.INVALID_KEY_PRIVATE,\n    )\n    return false\n  }\n  const keyName = `key[${String(key.kid)}]`\n\n  // check for private key material (as to happen before the following store.add, because the returned\n  // value will be the corresponding public key)\n  // Note: this is RSA/ECDSA specific, but ok since ECDSA is mandated\n  if ((key as JWK.Key & { d: string }).d) {\n    console.log(\n      `${keyName}: key contains private key material.`,\n      ErrorCode.INVALID_KEY_PRIVATE,\n    )\n    return false\n  }\n  // check that EC curve is 'ES256'\n  if (!key.alg) {\n    console.log(keyName + ': ' + \"'alg' missing in issuer key\", ErrorCode.INVALID_KEY_SCHEMA)\n    return false\n  } else if (key.alg !== 'ES256') {\n    console.log(\n      `${keyName}: wrong algorithm in issuer key. expected: 'ES256', actual: ${String(key.alg)}`,\n      ErrorCode.INVALID_KEY_WRONG_ALG,\n    )\n    return false\n  }\n\n  // check that key type is 'EC'\n  if (!key.kty) {\n    console.log(`${keyName}:'kty' missing in issuer key`, ErrorCode.INVALID_KEY_SCHEMA)\n    return false\n  } else if (key.kty !== 'EC') {\n    console.log(\n      `${keyName}:wrong key type in issuer key. expected: 'EC', actual: ${String( key.kty)} `,\n      ErrorCode.INVALID_KEY_WRONG_KTY,\n    )\n    return false\n  }\n\n  // check that usage is 'sig'\n  if (!key.use) {\n    console.log(`${keyName}:'use' missing in issuer key`, ErrorCode.INVALID_KEY_SCHEMA)\n    return false\n  } else if (key.use !== 'sig') {\n    console.log(\n      `${keyName}:wrong usage in issuer key. expected: 'sig', actual: ${String(key.use)}`,\n      ErrorCode.INVALID_KEY_WRONG_USE,\n    )\n    return false\n  }\n  try {\n    const jwkKey = await KeysStore.store.add(key)\n    const tpDigest: any = await jwkKey.thumbprint('SHA-256')\n    const thumbprint = jose.util.base64url.encode(tpDigest)\n    console.log(\"jwkThumbprint : \" + thumbprint )\n    if (key.kid !== thumbprint) {\n      console.log(\n        `${keyName}:'kid' does not match thumbprint in issuer key. expected: \\\n                    ${String( thumbprint )} , actual: ${String(key.kid)}`,\n        ErrorCode.INVALID_KEY_WRONG_KID,\n      )\n      jwkKey.error = new InvalidError(ErrorCode.INVALID_KEY_WRONG_KID)\n      return false\n    }\n\n  } catch ( err: any ){\n    console.log(\n      `${keyName}: Failed to calculate issuer key thumbprint : ${ String( err.message )}`,\n      ErrorCode.INVALID_KEY_UNKNOWN,\n    )\n    return false\n  }\n  return true\n}\n\nexport const verifyAndImportHealthCardIssuerKey = async (\n  keySet: KeySet\n): Promise<any> => {\n  // check that keySet is valid\n  if (!(keySet instanceof Object) || !keySet.keys || !(keySet.keys instanceof Array)) {\n    console.log('keySet not valid. Expect {keys : JWK.Key[]}', ErrorCode.INVALID_KEY_SCHEMA)\n    return\n  }\n  for (let i = 0; i < keySet.keys.length; i++) {\n    const key: JWK.Key = keySet.keys[i]\n    try {\n      if ( await addIfKeyIsValidSHCFormat( key ) ) {\n        console.debug(`Key [${String(i)}] added : `)\n      } else {\n        console.debug(`Key [${String(i)}] is not added`)\n      }\n    } catch (error) {\n      console.log(\n        'Error adding key to keyStore : ' + (error as Error).message,\n        ErrorCode.INVALID_KEY_UNKNOWN,\n      )\n    }\n  }\n  \n}\n"],"mappings":"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"}