{"version":3,"names":["schema","jwsPayloadSchema","validate","jwsPayloadText","trim","console","log","ErrorCode","TRAILING_CHARACTERS","jwsPayload","Utils","parseJson","isJwsPayloadValid","checkJwsPayload","Promise","reject","fhirBundleJson","vc","credentialSubject","fhirBundle","recordType","getRecordTypeFromPayload","JSON_PARSE_ERROR","nbf","Date","setTime","now","getTime","dateParsedInMilliseconds","toUTCString","NOT_YET_VALID","type","includes","SCHEMA_ERROR","InvalidError","CRITICAL_DATA_MISSING"],"sources":["jws-payload.ts"],"sourcesContent":["import { ErrorCode, Utils, InvalidError } from 'verifier-sdk'\nimport jwsPayloadSchema from '../../schemas/smart-health-card-vc-schema.json'\nimport * as fhirBundle from '../fhir/fhirBundle'\nimport { getRecordTypeFromPayload, RecordType } from '../fhir/fhirTypes'\nimport type { JWSPayload } from '../fhir/types' \nexport const schema = jwsPayloadSchema\n\n\nexport async function validate (jwsPayloadText: string): Promise< boolean > {\n  if (jwsPayloadText.trim() !== jwsPayloadText) {\n    console.log('JWS payload has leading or trailing spaces', ErrorCode.TRAILING_CHARACTERS)\n    jwsPayloadText = jwsPayloadText.trim()\n  }\n\n  const jwsPayload = Utils.parseJson<JWSPayload>(jwsPayloadText)\n  const isJwsPayloadValid = checkJwsPayload(jwsPayload)\n  if (!isJwsPayloadValid) return Promise.reject(false)\n \n  const fhirBundleJson = jwsPayload?.vc.credentialSubject.fhirBundle\n    \n  const recordType: RecordType = getRecordTypeFromPayload(jwsPayload as JWSPayload)\n  return fhirBundle.validate(recordType, fhirBundleJson)\n}\n\nfunction checkJwsPayload (jwsPayload: JWSPayload | undefined) {\n  if (!jwsPayload || typeof jwsPayload !== 'object') {\n    console.log('Failed to parse JWS.payload data as JSON.', ErrorCode.JSON_PARSE_ERROR)\n    return false\n  }\n  // validate issuance date\n  const nbf = new Date()\n  nbf.setTime(jwsPayload.nbf * 1000) // convert seconds to milliseconds\n  const now = new Date()\n\n  if (nbf > now) {\n    if (jwsPayload.nbf > new Date(2021, 1, 1).getTime()) {\n      // we will assume the nbf was encoded in milliseconds, and we will return an error\n      const dateParsedInMilliseconds = new Date()\n      dateParsedInMilliseconds.setTime(jwsPayload.nbf)\n      console.log(\n        `Health card is not yet valid, nbf=${jwsPayload.nbf} (${nbf.toUTCString()}).\\n` +\n          'nbf should be encoded in seconds since 1970-01-01T00:00:00Z UTC.\\n' +\n          `Did you encode the date in milliseconds, which would give the date: ${dateParsedInMilliseconds.toUTCString()}?`,\n        ErrorCode.NOT_YET_VALID,\n      )\n    } else {\n      console.log(\n        `Health card is not yet valid, nbf=${jwsPayload.nbf} (${nbf.toUTCString()}).`,\n        ErrorCode.NOT_YET_VALID,\n      )\n    }\n  }\n\n  if (\n    !jwsPayload.vc.type ||\n    !jwsPayload.vc.type.includes('https://smarthealth.cards#health-card')\n  ) {\n    console.log(\n      \"JWS.payload.vc.type should contain 'https://smarthealth.cards#health-card'\",\n      ErrorCode.SCHEMA_ERROR,\n    )\n    throw new InvalidError(  ErrorCode.SCHEMA_ERROR )\n  }\n\n  // to continue validation, we must have a FHIR bundle string to validate\n  if (\n    !jwsPayload.vc ||\n    !jwsPayload.vc.credentialSubject ||\n    !jwsPayload.vc.credentialSubject.fhirBundle\n  ) {\n    // The schema check above will list the expected properties/type\n    console.log(\n      'JWS.payload.vc.credentialSubject.fhirBundle{} required to continue.',\n      ErrorCode.CRITICAL_DATA_MISSING,\n    )\n    return false\n  }\n  return true\n}\n"],"mappings":";;;;;;;AAAA;AACA;AACA;AACA;AAAwE;AAAA;AAAA;AAEjE,MAAMA,MAAM,GAAGC,gCAAgB;AAAA;AAG/B,eAAeC,QAAQ,CAAEC,cAAsB,EAAsB;EAC1E,IAAIA,cAAc,CAACC,IAAI,EAAE,KAAKD,cAAc,EAAE;IAC5CE,OAAO,CAACC,GAAG,CAAC,4CAA4C,EAAEC,sBAAS,CAACC,mBAAmB,CAAC;IACxFL,cAAc,GAAGA,cAAc,CAACC,IAAI,EAAE;EACxC;EAEA,MAAMK,UAAU,GAAGC,kBAAK,CAACC,SAAS,CAAaR,cAAc,CAAC;EAC9D,MAAMS,iBAAiB,GAAGC,eAAe,CAACJ,UAAU,CAAC;EACrD,IAAI,CAACG,iBAAiB,EAAE,OAAOE,OAAO,CAACC,MAAM,CAAC,KAAK,CAAC;EAEpD,MAAMC,cAAc,GAAGP,UAAU,aAAVA,UAAU,uBAAVA,UAAU,CAAEQ,EAAE,CAACC,iBAAiB,CAACC,UAAU;EAElE,MAAMC,UAAsB,GAAG,IAAAC,mCAAwB,EAACZ,UAAU,CAAe;EACjF,OAAOU,UAAU,CAACjB,QAAQ,CAACkB,UAAU,EAAEJ,cAAc,CAAC;AACxD;AAEA,SAASH,eAAe,CAAEJ,UAAkC,EAAE;EAC5D,IAAI,CAACA,UAAU,IAAI,OAAOA,UAAU,KAAK,QAAQ,EAAE;IACjDJ,OAAO,CAACC,GAAG,CAAC,2CAA2C,EAAEC,sBAAS,CAACe,gBAAgB,CAAC;IACpF,OAAO,KAAK;EACd;EACA;EACA,MAAMC,GAAG,GAAG,IAAIC,IAAI,EAAE;EACtBD,GAAG,CAACE,OAAO,CAAChB,UAAU,CAACc,GAAG,GAAG,IAAI,CAAC,EAAC;EACnC,MAAMG,GAAG,GAAG,IAAIF,IAAI,EAAE;EAEtB,IAAID,GAAG,GAAGG,GAAG,EAAE;IACb,IAAIjB,UAAU,CAACc,GAAG,GAAG,IAAIC,IAAI,CAAC,IAAI,EAAE,CAAC,EAAE,CAAC,CAAC,CAACG,OAAO,EAAE,EAAE;MACnD;MACA,MAAMC,wBAAwB,GAAG,IAAIJ,IAAI,EAAE;MAC3CI,wBAAwB,CAACH,OAAO,CAAChB,UAAU,CAACc,GAAG,CAAC;MAChDlB,OAAO,CAACC,GAAG,CACR,qCAAoCG,UAAU,CAACc,GAAI,KAAIA,GAAG,CAACM,WAAW,EAAG,MAAK,GAC7E,oEAAoE,GACnE,uEAAsED,wBAAwB,CAACC,WAAW,EAAG,GAAE,EAClHtB,sBAAS,CAACuB,aAAa,CACxB;IACH,CAAC,MAAM;MACLzB,OAAO,CAACC,GAAG,CACR,qCAAoCG,UAAU,CAACc,GAAI,KAAIA,GAAG,CAACM,WAAW,EAAG,IAAG,EAC7EtB,sBAAS,CAACuB,aAAa,CACxB;IACH;EACF;EAEA,IACE,CAACrB,UAAU,CAACQ,EAAE,CAACc,IAAI,IACnB,CAACtB,UAAU,CAACQ,EAAE,CAACc,IAAI,CAACC,QAAQ,CAAC,uCAAuC,CAAC,EACrE;IACA3B,OAAO,CAACC,GAAG,CACT,4EAA4E,EAC5EC,sBAAS,CAAC0B,YAAY,CACvB;IACD,MAAM,IAAIC,yBAAY,CAAG3B,sBAAS,CAAC0B,YAAY,CAAE;EACnD;;EAEA;EACA,IACE,CAACxB,UAAU,CAACQ,EAAE,IACd,CAACR,UAAU,CAACQ,EAAE,CAACC,iBAAiB,IAChC,CAACT,UAAU,CAACQ,EAAE,CAACC,iBAAiB,CAACC,UAAU,EAC3C;IACA;IACAd,OAAO,CAACC,GAAG,CACT,qEAAqE,EACrEC,sBAAS,CAAC4B,qBAAqB,CAChC;IACD,OAAO,KAAK;EACd;EACA,OAAO,IAAI;AACb"}