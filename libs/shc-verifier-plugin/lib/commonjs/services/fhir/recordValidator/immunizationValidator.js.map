{"version":3,"names":["validate","entries","profileName","RecordType","covid19Immunization","immunizations","filter","entry","resource","resourceType","length","console","log","toString","ErrorCode","PROFILE_ERROR","Promise","reject","patients","expectedResources","forEach","index","includes","push","status","toLowerCase","code","vaccineCode","coding","_getCodeFunc","getVerifierInitOption","getAcceptedVaccineCodes","cvxCodes","join","immunizationDM","constraint","Utils","propPath","path","patientDM","resolve"],"sources":["immunizationValidator.ts"],"sourcesContent":["import { ErrorCode, Utils } from 'verifier-sdk'\nimport immunizationDM from '~/schemas/immunization-dm.json'\nimport patientDM from '~/schemas/patient-dm.json'\nimport { RecordType } from '../fhirTypes'\nimport { getVerifierInitOption } from '~/models/Config'\nimport type { ValidateFunction, BundleEntry } from '../types'\n\nconst validate: ValidateFunction  = async (entries: BundleEntry[])=> {\n  const profileName = RecordType.covid19Immunization\n  const immunizations = entries.filter((entry) => entry.resource.resourceType === 'Immunization')\n  if (immunizations.length === 0) {\n    console.log(\n      `Profile : ${profileName} : requires 1 or more Immunization resources. Actual : ${immunizations.length.toString()}`,\n      ErrorCode.PROFILE_ERROR,\n    )\n    return Promise.reject(false)\n  }\n\n  const patients = entries.filter((entry) => entry.resource.resourceType === 'Patient')\n\n  if (patients.length !== 1) {\n    console.log(\n      `Profile : ${profileName} : requires exactly 1 ${'Patient'} resource. Actual : ${patients.length.toString()}`,\n      ErrorCode.PROFILE_ERROR,\n    )\n  }\n\n  const expectedResources = ['Patient', 'Immunization']\n\n  entries.forEach( async (entry, index) => {\n    if (!expectedResources.includes(entry.resource.resourceType)) {\n      console.log(\n        `Profile : ${profileName} : resourceType: ${entry.resource.resourceType} is not allowed.`,\n        ErrorCode.PROFILE_ERROR,\n      )\n      expectedResources.push(entry.resource.resourceType) // prevent duplicates\n      return Promise.reject(false)\n    }\n\n    if (entry.resource.resourceType === 'Immunization') {\n\n      const status = ( entry.resource?.status ?? '' ).toLowerCase()\n      if ( status !== 'completed') {\n        console.log(`Record #${index} has invalid status code: ${status}`) \n      }\n      // verify that valid codes are used see : https://www.cdc.gov/vaccines/programs/iis/COVID-19-related-codes.html\n      const code = (entry.resource?.vaccineCode as { coding: Array<{ code: string }> })?.coding[0]\n        ?.code\n      const _getCodeFunc = getVerifierInitOption().getAcceptedVaccineCodes;\n      const cvxCodes =   _getCodeFunc? await _getCodeFunc(\"shc\"): [];\n\n      if (code && !cvxCodes.includes(code)) {\n        console.log(\n          `Profile : ${profileName} : Immunization.vaccineCode.code ( ${code } ) requires valid COVID-19 code (${cvxCodes.join(\n            ',',\n          )}).`,\n          ErrorCode.PROFILE_ERROR,\n        )\n      }\n\n      // check for properties that are forbidden by the dm-profiles\n      ;(immunizationDM as Array<{ path: string }>).forEach((constraint) => {\n        Utils.propPath(entry.resource, constraint.path) &&\n            console.log(\n              `Profile : ${profileName} : entry[${index.toString()}].resource.${\n                constraint.path\n              } should not be present.`,\n              ErrorCode.PROFILE_ERROR,\n            )\n      })\n    }\n\n    if (entry.resource.resourceType === 'Patient') {\n      // check for properties that are forbidden by the dm-profiles\n      ;(patientDM as Array<{ path: string }>).forEach((constraint) => {\n        Utils.propPath(entry.resource, constraint.path) &&\n            console.log(\n              `Profile : ${profileName} : entry[${index.toString()}].resource.${\n                constraint.path\n              } should not be present.`,\n              ErrorCode.PROFILE_ERROR,\n            )\n      })\n    }\n  })\n\n  return Promise.resolve(true)\n}\n\nexport default validate\n"],"mappings":"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"}