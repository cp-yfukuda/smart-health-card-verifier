{"version":3,"names":["_parserSdk","require","_immunizationDm","_interopRequireDefault","_patientDm","_fhirTypes","_Config","obj","__esModule","default","validate","entries","profileName","RecordType","immunization","immunizations","filter","entry","resource","resourceType","length","console","log","toString","ErrorCode","PROFILE_ERROR","Promise","reject","patients","expectedResources","forEach","index","includes","push","_entry$resource","_entry$resource2","_entry$resource2$vacc","_entry$resource2$vacc2","status","toLowerCase","code","vaccineCode","coding","_getCodeFunc","getVerifierInitOption","getAcceptedVaccineCodes","cvxCodes","join","immunizationDM","constraint","Utils","propPath","path","patientDM","resolve","_default","exports"],"sources":["immunizationValidator.ts"],"sourcesContent":["import { ErrorCode, Utils } from 'parser-sdk'\nimport immunizationDM from '../../../schemas/immunization-dm.json'\nimport patientDM from '../../../schemas/patient-dm.json'\nimport { RecordType } from '../fhirTypes'\nimport { getVerifierInitOption } from '../../../models/Config'\nimport type { ValidateFunction, BundleEntry } from '../types'\n\nconst validate: ValidateFunction  = async (entries: BundleEntry[])=> {\n  const profileName = RecordType.immunization\n  const immunizations = entries.filter((entry) => entry.resource.resourceType === 'Immunization')\n  if (immunizations.length === 0) {\n    console.log(\n      `Profile : ${profileName} : requires 1 or more Immunization resources. Actual : ${immunizations.length.toString()}`,\n      ErrorCode.PROFILE_ERROR,\n    )\n    return Promise.reject(false)\n  }\n\n  const patients = entries.filter((entry) => entry.resource.resourceType === 'Patient')\n\n  if (patients.length !== 1) {\n    console.log(\n      `Profile : ${profileName} : requires exactly 1 ${'Patient'} resource. Actual : ${patients.length.toString()}`,\n      ErrorCode.PROFILE_ERROR,\n    )\n  }\n\n  const expectedResources = ['Patient', 'Immunization']\n\n  entries.forEach( async (entry, index) => {\n    if (!expectedResources.includes(entry.resource.resourceType)) {\n      console.log(\n        `Profile : ${profileName} : resourceType: ${entry.resource.resourceType} is not allowed.`,\n        ErrorCode.PROFILE_ERROR,\n      )\n      expectedResources.push(entry.resource.resourceType) // prevent duplicates\n      return Promise.reject(false)\n    }\n\n    if (entry.resource.resourceType === 'Immunization') {\n\n      const status = ( entry.resource?.status ?? '' ).toLowerCase()\n      if ( status !== 'completed') {\n        console.log(`Record #${index} has invalid status code: ${status}`) \n      }\n      // verify that valid codes are used see : https://www.cdc.gov/vaccines/programs/iis/COVID-19-related-codes.html\n      const code = (entry.resource?.vaccineCode as { coding: Array<{ code: string }> })?.coding[0]\n        ?.code\n      const _getCodeFunc = getVerifierInitOption().getAcceptedVaccineCodes;\n      const cvxCodes =   _getCodeFunc? await _getCodeFunc(\"shc\"): [];\n\n      if (code && !cvxCodes.includes(code)) {\n        console.log(\n          `Profile : ${profileName} : Immunization.vaccineCode.code ( ${code } ) requires valid COVID-19 code (${cvxCodes.join(\n            ',',\n          )}).`,\n          ErrorCode.PROFILE_ERROR,\n        )\n      }\n\n      // check for properties that are forbidden by the dm-profiles\n      ;(immunizationDM as Array<{ path: string }>).forEach((constraint) => {\n        Utils.propPath(entry.resource, constraint.path) &&\n            console.log(\n              `Profile : ${profileName} : entry[${index.toString()}].resource.${\n                constraint.path\n              } should not be present.`,\n              ErrorCode.PROFILE_ERROR,\n            )\n      })\n    }\n\n    if (entry.resource.resourceType === 'Patient') {\n      // check for properties that are forbidden by the dm-profiles\n      ;(patientDM as Array<{ path: string }>).forEach((constraint) => {\n        Utils.propPath(entry.resource, constraint.path) &&\n            console.log(\n              `Profile : ${profileName} : entry[${index.toString()}].resource.${\n                constraint.path\n              } should not be present.`,\n              ErrorCode.PROFILE_ERROR,\n            )\n      })\n    }\n  })\n\n  return Promise.resolve(true)\n}\n\nexport default validate\n"],"mappings":"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"}