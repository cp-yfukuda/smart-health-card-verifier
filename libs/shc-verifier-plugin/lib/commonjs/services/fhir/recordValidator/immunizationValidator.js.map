{"version":3,"names":["validate","entries","profileName","RecordType","immunization","immunizations","filter","entry","resource","resourceType","length","console","log","toString","ErrorCode","PROFILE_ERROR","Promise","reject","patients","expectedResources","forEach","index","includes","push","status","toLowerCase","code","vaccineCode","coding","_getCodeFunc","getVerifierInitOption","getAcceptedVaccineCodes","cvxCodes","join","immunizationDM","constraint","Utils","propPath","path","patientDM","resolve"],"sources":["immunizationValidator.ts"],"sourcesContent":["import { ErrorCode, Utils } from 'verifier-sdk'\nimport immunizationDM from '../../../schemas/immunization-dm.json'\nimport patientDM from '../../../schemas/patient-dm.json'\nimport { RecordType } from '../fhirTypes'\nimport { getVerifierInitOption } from '../../../models/Config'\nimport type { ValidateFunction, BundleEntry } from '../types'\n\nconst validate: ValidateFunction  = async (entries: BundleEntry[])=> {\n  const profileName = RecordType.immunization\n  const immunizations = entries.filter((entry) => entry.resource.resourceType === 'Immunization')\n  if (immunizations.length === 0) {\n    console.log(\n      `Profile : ${profileName} : requires 1 or more Immunization resources. Actual : ${immunizations.length.toString()}`,\n      ErrorCode.PROFILE_ERROR,\n    )\n    return Promise.reject(false)\n  }\n\n  const patients = entries.filter((entry) => entry.resource.resourceType === 'Patient')\n\n  if (patients.length !== 1) {\n    console.log(\n      `Profile : ${profileName} : requires exactly 1 ${'Patient'} resource. Actual : ${patients.length.toString()}`,\n      ErrorCode.PROFILE_ERROR,\n    )\n  }\n\n  const expectedResources = ['Patient', 'Immunization']\n\n  entries.forEach( async (entry, index) => {\n    if (!expectedResources.includes(entry.resource.resourceType)) {\n      console.log(\n        `Profile : ${profileName} : resourceType: ${entry.resource.resourceType} is not allowed.`,\n        ErrorCode.PROFILE_ERROR,\n      )\n      expectedResources.push(entry.resource.resourceType) // prevent duplicates\n      return Promise.reject(false)\n    }\n\n    if (entry.resource.resourceType === 'Immunization') {\n\n      const status = ( entry.resource?.status ?? '' ).toLowerCase()\n      if ( status !== 'completed') {\n        console.log(`Record #${index} has invalid status code: ${status}`) \n      }\n      // verify that valid codes are used see : https://www.cdc.gov/vaccines/programs/iis/COVID-19-related-codes.html\n      const code = (entry.resource?.vaccineCode as { coding: Array<{ code: string }> })?.coding[0]\n        ?.code\n      const _getCodeFunc = getVerifierInitOption().getAcceptedVaccineCodes;\n      const cvxCodes =   _getCodeFunc? await _getCodeFunc(\"shc\"): [];\n\n      if (code && !cvxCodes.includes(code)) {\n        console.log(\n          `Profile : ${profileName} : Immunization.vaccineCode.code ( ${code } ) requires valid COVID-19 code (${cvxCodes.join(\n            ',',\n          )}).`,\n          ErrorCode.PROFILE_ERROR,\n        )\n      }\n\n      // check for properties that are forbidden by the dm-profiles\n      ;(immunizationDM as Array<{ path: string }>).forEach((constraint) => {\n        Utils.propPath(entry.resource, constraint.path) &&\n            console.log(\n              `Profile : ${profileName} : entry[${index.toString()}].resource.${\n                constraint.path\n              } should not be present.`,\n              ErrorCode.PROFILE_ERROR,\n            )\n      })\n    }\n\n    if (entry.resource.resourceType === 'Patient') {\n      // check for properties that are forbidden by the dm-profiles\n      ;(patientDM as Array<{ path: string }>).forEach((constraint) => {\n        Utils.propPath(entry.resource, constraint.path) &&\n            console.log(\n              `Profile : ${profileName} : entry[${index.toString()}].resource.${\n                constraint.path\n              } should not be present.`,\n              ErrorCode.PROFILE_ERROR,\n            )\n      })\n    }\n  })\n\n  return Promise.resolve(true)\n}\n\nexport default validate\n"],"mappings":"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"}