{"version":3,"names":["pako","jose","InvalidError","Utils","Timer","ErrorCode","getVerifierInitOption","VerifierKey","KeysStore","jwsPayload","validateSchema","jwsCompactSchema","verifyAndImportHealthCardIssuerKey","getRecord","JwsValidationOptions","skipJwksDownload","jwksDownloadTimeOut","MAX_JWS_SINGLE_CHUNK_LENGTH","validate","jws","resetStore","trim","console","log","TRAILING_CHARACTERS","length","JWS_TOO_LONG","jwsRegex","isJws","test","JSON_PARSE_ERROR","header","rawPayload","key","split","headerJson","checkJwsHeader","checkJwsSignatureFormat","inflatedPayload","b64DecodedPayloadString","checkJwsPayload","join","isJwsPayloadValid","err","payload","parseJson","extractKeyURL","result","isValid","verifyJws","kid","document","fetchWithTimeout","url","options","timeout","timeoutError","Promise","race","fetch","_","reject","setTimeout","Error","downloadAndImportValidKeys","issuerURL","timer","jwkURL","requestedOrigin","start","responseRaw","headers","Origin","catch","ISSUER_KEY_DOWNLOAD_ERROR","keySet","json","loadingTime","stop","toFixed","String","message","headerBytes","errString","Buffer","from","JWS_VERIFICATION_ERROR","toString","JWS_HEADER_ERROR","headerKeys","Object","keys","includes","alg","zip","sigBytes","SIGNATURE_FORMAT_ERROR","rStart","rBytes","slice","sStart","sBytes","newSig","concat","replace","b64DecodedPayloadBuffer","inflateRaw","to","inflate","INFLATION_ERROR","iss","INVALID_ISSUER_URL","useLegacy","getIssuerFunc","getIssuer","store","get","error","verifier","JWS","createVerify","verify"],"sources":["jws-compact.ts"],"sourcesContent":["/* eslint no-catch-shadow: off, no-shadow: off */\nimport pako from 'pako'\nimport jose from 'node-jose'\n\nimport { InvalidError, Utils, Timer } from 'verifier-sdk'\nimport type { JWSPayload } from '../fhir/types'\nimport { ErrorCode } from 'verifier-sdk'\nimport { getVerifierInitOption, VerifierKey } from '../../models/Config'\nimport { KeysStore } from './keys'\nimport * as jwsPayload from './jws-payload'\nimport { validateSchema } from './schema'\nimport jwsCompactSchema from '../../schemas/jws-schema.json'\nimport { verifyAndImportHealthCardIssuerKey } from './shcKeyValidator'\nimport { getRecord } from '../fhir/fhirBundle'\nexport const JwsValidationOptions = {\n  skipJwksDownload: false,\n  jwksDownloadTimeOut: 5000,\n}\n\nconst MAX_JWS_SINGLE_CHUNK_LENGTH = 1195\n\nexport async function validate ( jws: string ): Promise<any> {\n  KeysStore.resetStore()\n  if (jws.trim() !== jws) {\n    console.log('JWS has leading or trailing spaces', ErrorCode.TRAILING_CHARACTERS)\n    jws = jws.trim()\n  }\n  if (jws.length > MAX_JWS_SINGLE_CHUNK_LENGTH) {\n    console.log(\n      `JWS is longer than ${MAX_JWS_SINGLE_CHUNK_LENGTH} characters, and will result in split QR codes`,\n      ErrorCode.JWS_TOO_LONG,\n    )\n  }\n\n  const jwsRegex = /[0-9a-zA-Z_-]+\\.[0-9a-zA-Z_-]+\\.[0-9a-zA-Z_-]+/g\n  const isJws = jwsRegex.test(jws)\n  if (!isJws) {\n    console.log(\n      \"Failed to parse JWS-compact data as 'base64url.base64url.base64url' string.\",\n      ErrorCode.JSON_PARSE_ERROR,\n    )\n    return false\n  }\n\n  // failures will be recorded in the console.logan continue processing.\n  validateSchema(jwsCompactSchema, jws)\n\n  // split jws into header, payload, key\n  let [header, rawPayload, key] = jws.split('.')\n  const headerJson = checkJwsHeader(header)\n  key = checkJwsSignatureFormat(key)\n  const { inflatedPayload, b64DecodedPayloadString } = checkJwsPayload(rawPayload)\n\n  jws = [header, rawPayload, key].join('.')\n\n  try {\n    const isJwsPayloadValid = await jwsPayload.validate(\n      inflatedPayload || b64DecodedPayloadString || rawPayload,\n    )\n    if (!isJwsPayloadValid) {\n      console.log('ERROR at jwsPayload.validate!')\n    }\n  }catch (err) {\n    console.log('ERROR at jwsPayload.validate!')\n    //#TODO throw error? \n  }\n  // try to parse JSON even if it failed validation above\n  // if we did not get a payload back, it failed to be parsed and we cannot extract the key url\n  // so we can stop. The jws-payload child will contain the parse errors.\n  // The payload validation may have a Fatal error\n  const payload = Utils.parseJson<JWSPayload>(inflatedPayload || b64DecodedPayloadString || rawPayload)\n  if (!payload) {\n    console.log('NO PAYLOAD!!')\n    return\n  }\n\n  try { \n    await extractKeyURL(payload)\n  } catch (err) {\n    if (err instanceof InvalidError) throw err\n    return \n  }\n  const result = false\n  if (!headerJson) {\n    return result\n  }\n\n  const isValid = await verifyJws(jws, headerJson.kid)\n  let document = await getRecord( payload ) as any\n\n  document['isValid'] = isValid\n\n  return document\n}\n\nasync function fetchWithTimeout (url: string, options: any, timeout: number, timeoutError: string) {\n  return await Promise.race([\n    fetch(url, options),\n\n    new Promise((_:any, reject) => setTimeout(() => reject(new Error(timeoutError)), timeout)),\n  ])\n}\n\nasync function downloadAndImportValidKeys (issuerURL: string ): Promise<boolean> {\n  const timer = new Timer()\n  const jwkURL = issuerURL + '/.well-known/jwks.json'\n  const requestedOrigin = 'https://example.org' // request bogus origin to test CORS response\n\n  const timeoutError = 'Failed to download issuer JWK set'\n  const timeout = JwsValidationOptions.jwksDownloadTimeOut\n  try {\n    timer.start()\n    const responseRaw: any = await fetchWithTimeout(\n      jwkURL,\n      { headers: { Origin: requestedOrigin } },\n      timeout,\n      timeoutError,\n    ).catch( ( _:any )=> {\n      throw new InvalidError( ErrorCode.ISSUER_KEY_DOWNLOAD_ERROR )\n    })\n    const keySet = await responseRaw.json()\n    let loadingTime = timer.stop()\n    console.log(`loading issure key: ${loadingTime.toFixed(2)}sec`)\n    if (!keySet) {\n      throw new Error('Failed to parse JSON KeySet schema')\n    }\n\n    try {\n      timer.start()\n      await verifyAndImportHealthCardIssuerKey(keySet)\n      loadingTime = timer.stop()\n      console.log(`verification took:  ${loadingTime.toFixed(2)}sec`)\n\n      return true\n    } catch ( err : any ) {\n      console.log(\n        `Can't parse downloaded issuer JWK set: ${String(err.message)}`,\n        ErrorCode.ISSUER_KEY_DOWNLOAD_ERROR,\n      )\n      return false\n    }\n  } catch (err: any) {\n    if ( err instanceof InvalidError ) throw err\n    console.log(\n      `Failed to download issuer JWK set:  ${String(err.message)}`,\n      ErrorCode.ISSUER_KEY_DOWNLOAD_ERROR,\n    )\n    // return undefined\n\n    throw new Error(timeoutError)\n  }\n}\n\nfunction checkJwsHeader (header: string) {\n  let headerBytes\n  let errString\n\n  try {\n    headerBytes = Buffer.from(header, 'base64')\n  } catch (err) {\n    errString = err as string\n  } finally {\n    if (!headerBytes) {\n      console.log(\n        ['Error base64-decoding the JWS header.', errString].join('\\n'),\n        ErrorCode.JWS_VERIFICATION_ERROR,\n      )\n    }\n  }\n\n  let headerJson\n\n  if (headerBytes) {\n    headerJson = Utils.parseJson<{ kid: string, alg: string, zip: string }>(headerBytes.toString())\n    if (headerJson == null) {\n      console.log(\n        [\"Can't parse JWS header as JSON.\", errString].join('\\n'),\n        ErrorCode.JWS_HEADER_ERROR,\n      )\n    } else {\n      const headerKeys = Object.keys(headerJson)\n\n      if (!headerKeys.includes('alg')) {\n        console.log(\"JWS header missing 'alg' property.\", ErrorCode.JWS_HEADER_ERROR)\n      } else if (headerJson.alg !== 'ES256') {\n        console.log(\n          `Wrong value for JWS header property 'alg' property expected: \"ES256\", actual: \"${headerJson.alg}\".`,\n          ErrorCode.JWS_HEADER_ERROR,\n        )\n      }\n      if (!headerKeys.includes('zip')) {\n        console.log(\"JWS header missing 'zip' property.\", ErrorCode.JWS_HEADER_ERROR)\n      } else if (headerJson.zip !== 'DEF') {\n        console.log(\n          `Wrong value for JWS header property 'zip' property expected: \"DEF\", actual: \"${headerJson.zip}\".`,\n          ErrorCode.JWS_HEADER_ERROR,\n        )\n      }\n      if (!headerKeys.includes('kid')) {\n        console.log(\"JWS header missing 'kid' property.\", ErrorCode.JWS_HEADER_ERROR)\n      }\n\n      // the value of the kid will be used in the crypto validation of the signature to select the issuer's public key\n    }\n  }\n\n  return headerJson\n}\n\nfunction checkJwsSignatureFormat (key: string) {\n  let sigBytes\n  try {\n    sigBytes = Buffer.from(key, 'base64')\n  } catch (err) {\n    console.log(\n      ['Error base64-decoding the JWS signature.', err as string].join('\\n'),\n      ErrorCode.JWS_VERIFICATION_ERROR,\n    )\n  }\n\n  if (sigBytes && sigBytes.length > 64 && sigBytes[0] === 0x30 && sigBytes[2] === 0x02) {\n    console.log(\n      'Signature appears to be in DER encoded form. Signature is expected to be 64-byte r||s concatenated form.\\n' +\n        'See https://tools.ietf.org/html/rfc7515#appendix-A.3 for expected ES256 signature form.',\n      ErrorCode.SIGNATURE_FORMAT_ERROR,\n    )\n\n    // DER encoded signature will constructed as follows:\n    // 0       |1             |2      |3         |4-35             |36       |37        |38-69\n    // 0x30      |0x44          |0x02     |0x20        |<r-component of signature> |0x02     |0x20 or 0x21    |<s-component of signature>\n    // Sequence-type |length-of-sequence-data |Integer-type |length-of-integer |integer-data         |Integer-type |length-of-integer |integer-data\n\n    // sigBytes[3] contains length of r-integer it may be 32 or 33 bytes.\n    // DER encoding dictates an Integer is negative if the high-order bit of the first byte is set.\n    //   To represent an integer with a high-order bit as positive, a leading zero byte is required.\n    //   This increases the Integer length to 33.\n\n    // For signature use, the sign is irrelevant and the leading zero, if present, is ignored.\n    const rStart = 4 + (sigBytes[3] - 32) // adjust for the potential leading zero\n    const rBytes = sigBytes.slice(rStart, rStart + 32) // 32 bytes of the r-integer\n    const sStart = sigBytes.length - 32\n    const sBytes = sigBytes.slice(sStart) // 32 bytes of the s-integer\n\n    // Make Base64url\n    const newSig = Buffer.concat([rBytes, sBytes])\n      .toString('base64')\n      .replace(/\\+/g, '-')\n      .replace(/\\//g, '_')\n      .replace(/[=]/g, '')\n    key = newSig\n\n    console.log('jws-signature converted from DER form to r||s form: ' + newSig)\n  } else if (sigBytes && sigBytes.length !== 64) {\n    console.log(\n      'Signature is ' + sigBytes.length.toString() + '-bytes. Signature is expected to be 64-bytes',\n      ErrorCode.SIGNATURE_FORMAT_ERROR,\n    )\n  }\n  return key\n}\n\nfunction checkJwsPayload (rawPayload: string) {\n  // check payload\n  let b64DecodedPayloadBuffer\n  let b64DecodedPayloadString\n\n  try {\n    b64DecodedPayloadBuffer = Buffer.from(rawPayload, 'base64')\n  } catch (err) {\n    console.log(\n      ['Error base64-decoding the JWS payload.', err as string].join('\\n'),\n      ErrorCode.JWS_VERIFICATION_ERROR,\n    )\n  }\n\n  let inflatedPayload\n\n  if (b64DecodedPayloadBuffer) {\n    try {\n      inflatedPayload = pako.inflateRaw(b64DecodedPayloadBuffer, { to: 'string' }).trim()\n    } catch (err) {\n      // try normal inflate\n      try {\n        inflatedPayload = pako.inflate(b64DecodedPayloadBuffer, { to: 'string' }).trim()\n        console.log(\n          'Error inflating JWS payload. Compression should use raw DEFLATE (without wrapper header and adler32 crc)',\n          ErrorCode.INFLATION_ERROR,\n        )\n      } catch (err) {\n        console.log(\n          ['Error inflating JWS payload. Did you use raw DEFLATE compression?', err as string].join(\n            '\\n',\n          ),\n          ErrorCode.INFLATION_ERROR,\n        )\n        // inflating failed, let's try to parse the base64-decoded string directly\n        b64DecodedPayloadString = b64DecodedPayloadBuffer.toString('utf-8').trim()\n      }\n    }\n  }\n  return { inflatedPayload, b64DecodedPayloadString }\n}\n\nasync function extractKeyURL (payload: any) {\n  if (payload.iss) {\n    if (typeof payload.iss === 'string') {\n      if (payload.iss.slice(0, 8) !== 'https://') {\n        console.log('Issuer URL SHALL use https', ErrorCode.INVALID_ISSUER_URL)\n      }\n\n      if (payload.iss.slice(-1) === '/') {\n        console.log('Issuer URL SHALL NOT include a trailing /', ErrorCode.INVALID_ISSUER_URL)\n      }\n      // from issuer data in the vci directory, look for issuer data.\n      var iss= payload.iss\n      var useLegacy = getVerifierInitOption().useLegacy\n      if( ! useLegacy  ) {\n         //switch to canonical_iss if there is \n         var getIssuerFunc = getVerifierInitOption().getIssuer\n         iss = await getIssuerFunc( VerifierKey, payload.iss ) ?? payload.iss\n      }\n      // download the keys into the keystore. if it fails, continue an try to use whatever is in the keystore.\n      if (!JwsValidationOptions.skipJwksDownload) {\n\n        await downloadAndImportValidKeys( iss )\n      } else {\n        console.log('skipping issuer JWK set download')\n      }\n    } else {\n      console.log(`JWS payload 'iss' should be a string, not a ${typeof payload.iss}`)\n    }\n  } else {\n    throw new Error(\"Can't find 'iss' entry in JWS payload\")\n  }\n}\n\nasync function verifyJws (jws: string, kid: string): Promise<boolean> {\n  var key: any | null = null;\n  if (kid && ! ( key = KeysStore.store.get(kid))) {\n    console.log(\n      `JWS verification failed: can't find key with 'kid' = ${kid} in issuer set`,\n      ErrorCode.JWS_VERIFICATION_ERROR,\n    )\n  }\n  if( key && key.error && key.error instanceof InvalidError ) {\n    throw key.error\n  }\n  const verifier: jose.JWS.Verifier = jose.JWS.createVerify(KeysStore.store)\n\n  try {\n    const result = await verifier.verify(jws)\n    return !!result\n\n  } catch (error) {\n    // The error message is always 'no key found', regardless if a key is missing or\n    // if the signature was tempered with. Don't return the node-jose error message.\n    console.log('JWS verification failed', ErrorCode.JWS_VERIFICATION_ERROR)\n    return false\n  }\n}\n"],"mappings":"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"}