{"version":3,"names":["pako","jose","InvalidError","Utils","Timer","ErrorCode","getVerifierInitOption","VerifierKey","KeysStore","jwsPayload","validateSchema","jwsCompactSchema","verifyAndImportHealthCardIssuerKey","getRecord","JwsValidationOptions","skipJwksDownload","jwksDownloadTimeOut","MAX_JWS_SINGLE_CHUNK_LENGTH","validate","jws","resetStore","trim","console","log","TRAILING_CHARACTERS","length","JWS_TOO_LONG","jwsRegex","isJws","test","JSON_PARSE_ERROR","header","rawPayload","key","split","headerJson","checkJwsHeader","checkJwsSignatureFormat","inflatedPayload","b64DecodedPayloadString","checkJwsPayload","join","isJwsPayloadValid","err","payload","parseJson","extractKeyURL","result","isValid","verifyJws","kid","document","fetchWithTimeout","url","options","timeout","timeoutError","Promise","race","fetch","_","reject","setTimeout","Error","downloadAndImportValidKeys","issuerURL","timer","jwkURL","requestedOrigin","start","responseRaw","headers","Origin","catch","ISSUER_KEY_DOWNLOAD_ERROR","keySet","json","loadingTime","stop","toFixed","String","message","headerBytes","errString","Buffer","from","JWS_VERIFICATION_ERROR","toString","JWS_HEADER_ERROR","headerKeys","Object","keys","includes","alg","zip","sigBytes","SIGNATURE_FORMAT_ERROR","rStart","rBytes","slice","sStart","sBytes","newSig","concat","replace","b64DecodedPayloadBuffer","inflateRaw","to","inflate","INFLATION_ERROR","iss","INVALID_ISSUER_URL","useLegacy","getIssuerFunc","getIssuer","store","get","error","verifier","JWS","createVerify","verify"],"sources":["jws-compact.ts"],"sourcesContent":["/* eslint no-catch-shadow: off, no-shadow: off */\nimport pako from 'pako'\nimport jose from 'react-native-jose'\n\nimport { InvalidError, Utils, Timer } from 'verifier-sdk'\nimport type { JWSPayload } from '../fhir/types'\nimport { ErrorCode } from 'verifier-sdk'\nimport { getVerifierInitOption, VerifierKey } from '~/models/Config'\nimport { KeysStore } from './keys'\nimport * as jwsPayload from './jws-payload'\nimport { validateSchema } from './schema'\nimport jwsCompactSchema from '../../schemas/jws-schema.json'\nimport { verifyAndImportHealthCardIssuerKey } from './shcKeyValidator'\nimport { getRecord } from '../fhir/fhirBundle'\nexport const JwsValidationOptions = {\n  skipJwksDownload: false,\n  jwksDownloadTimeOut: 5000,\n}\n\nconst MAX_JWS_SINGLE_CHUNK_LENGTH = 1195\n\nexport async function validate ( jws: string ): Promise<any> {\n  KeysStore.resetStore()\n  if (jws.trim() !== jws) {\n    console.log('JWS has leading or trailing spaces', ErrorCode.TRAILING_CHARACTERS)\n    jws = jws.trim()\n  }\n  if (jws.length > MAX_JWS_SINGLE_CHUNK_LENGTH) {\n    console.log(\n      `JWS is longer than ${MAX_JWS_SINGLE_CHUNK_LENGTH} characters, and will result in split QR codes`,\n      ErrorCode.JWS_TOO_LONG,\n    )\n  }\n\n  const jwsRegex = /[0-9a-zA-Z_-]+\\.[0-9a-zA-Z_-]+\\.[0-9a-zA-Z_-]+/g\n  const isJws = jwsRegex.test(jws)\n  if (!isJws) {\n    console.log(\n      \"Failed to parse JWS-compact data as 'base64url.base64url.base64url' string.\",\n      ErrorCode.JSON_PARSE_ERROR,\n    )\n    return false\n  }\n\n  // failures will be recorded in the console.logan continue processing.\n  validateSchema(jwsCompactSchema, jws)\n\n  // split jws into header, payload, key\n  let [header, rawPayload, key] = jws.split('.')\n  const headerJson = checkJwsHeader(header)\n  key = checkJwsSignatureFormat(key)\n  const { inflatedPayload, b64DecodedPayloadString } = checkJwsPayload(rawPayload)\n\n  jws = [header, rawPayload, key].join('.')\n\n  try {\n    const isJwsPayloadValid = await jwsPayload.validate(\n      inflatedPayload || b64DecodedPayloadString || rawPayload,\n    )\n    if (!isJwsPayloadValid) {\n      console.log('ERROR at jwsPayload.validate!')\n    }\n  }catch (err) {\n    console.log('ERROR at jwsPayload.validate!')\n    //#TODO throw error? \n  }\n  // try to parse JSON even if it failed validation above\n  // if we did not get a payload back, it failed to be parsed and we cannot extract the key url\n  // so we can stop. The jws-payload child will contain the parse errors.\n  // The payload validation may have a Fatal error\n  const payload = Utils.parseJson<JWSPayload>(inflatedPayload || b64DecodedPayloadString || rawPayload)\n  if (!payload) {\n    console.log('NO PAYLOAD!!')\n    return\n  }\n\n  try { \n    await extractKeyURL(payload)\n  } catch (err) {\n    if (err instanceof InvalidError) throw err\n    return \n  }\n  const result = false\n  if (!headerJson) {\n    return result\n  }\n\n  const isValid = await verifyJws(jws, headerJson.kid)\n  let document = await getRecord( payload )\n\n  document = {\n    isValid,\n    ...document\n  }\n\n  return document\n}\n\nasync function fetchWithTimeout (url: string, options: any, timeout: number, timeoutError: string) {\n  return await Promise.race([\n    fetch(url, options),\n\n    new Promise((_:any, reject) => setTimeout(() => reject(new Error(timeoutError)), timeout)),\n  ])\n}\n\nasync function downloadAndImportValidKeys (issuerURL: string ): Promise<boolean> {\n  const timer = new Timer()\n  const jwkURL = issuerURL + '/.well-known/jwks.json'\n  const requestedOrigin = 'https://example.org' // request bogus origin to test CORS response\n\n  const timeoutError = 'Failed to download issuer JWK set'\n  const timeout = JwsValidationOptions.jwksDownloadTimeOut\n  try {\n    timer.start()\n    const responseRaw: any = await fetchWithTimeout(\n      jwkURL,\n      { headers: { Origin: requestedOrigin } },\n      timeout,\n      timeoutError,\n    ).catch( ( _:any )=> {\n      throw new InvalidError( ErrorCode.ISSUER_KEY_DOWNLOAD_ERROR )\n    })\n    const keySet = await responseRaw.json()\n    let loadingTime = timer.stop()\n    console.log(`loading issure key: ${loadingTime.toFixed(2)}sec`)\n    if (!keySet) {\n      throw new Error('Failed to parse JSON KeySet schema')\n    }\n\n    try {\n      timer.start()\n      await verifyAndImportHealthCardIssuerKey(keySet)\n      loadingTime = timer.stop()\n      console.log(`verification took:  ${loadingTime.toFixed(2)}sec`)\n\n      return true\n    } catch ( err : any ) {\n      console.log(\n        `Can't parse downloaded issuer JWK set: ${String(err.message)}`,\n        ErrorCode.ISSUER_KEY_DOWNLOAD_ERROR,\n      )\n      return false\n    }\n  } catch (err: any) {\n    if ( err instanceof InvalidError ) throw err\n    console.log(\n      `Failed to download issuer JWK set:  ${String(err.message)}`,\n      ErrorCode.ISSUER_KEY_DOWNLOAD_ERROR,\n    )\n    // return undefined\n\n    throw new Error(timeoutError)\n  }\n}\n\nfunction checkJwsHeader (header: string) {\n  let headerBytes\n  let errString\n\n  try {\n    headerBytes = Buffer.from(header, 'base64')\n  } catch (err) {\n    errString = err as string\n  } finally {\n    if (!headerBytes) {\n      console.log(\n        ['Error base64-decoding the JWS header.', errString].join('\\n'),\n        ErrorCode.JWS_VERIFICATION_ERROR,\n      )\n    }\n  }\n\n  let headerJson\n\n  if (headerBytes) {\n    headerJson = Utils.parseJson<{ kid: string, alg: string, zip: string }>(headerBytes.toString())\n    if (headerJson == null) {\n      console.log(\n        [\"Can't parse JWS header as JSON.\", errString].join('\\n'),\n        ErrorCode.JWS_HEADER_ERROR,\n      )\n    } else {\n      const headerKeys = Object.keys(headerJson)\n\n      if (!headerKeys.includes('alg')) {\n        console.log(\"JWS header missing 'alg' property.\", ErrorCode.JWS_HEADER_ERROR)\n      } else if (headerJson.alg !== 'ES256') {\n        console.log(\n          `Wrong value for JWS header property 'alg' property expected: \"ES256\", actual: \"${headerJson.alg}\".`,\n          ErrorCode.JWS_HEADER_ERROR,\n        )\n      }\n      if (!headerKeys.includes('zip')) {\n        console.log(\"JWS header missing 'zip' property.\", ErrorCode.JWS_HEADER_ERROR)\n      } else if (headerJson.zip !== 'DEF') {\n        console.log(\n          `Wrong value for JWS header property 'zip' property expected: \"DEF\", actual: \"${headerJson.zip}\".`,\n          ErrorCode.JWS_HEADER_ERROR,\n        )\n      }\n      if (!headerKeys.includes('kid')) {\n        console.log(\"JWS header missing 'kid' property.\", ErrorCode.JWS_HEADER_ERROR)\n      }\n\n      // the value of the kid will be used in the crypto validation of the signature to select the issuer's public key\n    }\n  }\n\n  return headerJson\n}\n\nfunction checkJwsSignatureFormat (key: string) {\n  let sigBytes\n  try {\n    sigBytes = Buffer.from(key, 'base64')\n  } catch (err) {\n    console.log(\n      ['Error base64-decoding the JWS signature.', err as string].join('\\n'),\n      ErrorCode.JWS_VERIFICATION_ERROR,\n    )\n  }\n\n  if (sigBytes && sigBytes.length > 64 && sigBytes[0] === 0x30 && sigBytes[2] === 0x02) {\n    console.log(\n      'Signature appears to be in DER encoded form. Signature is expected to be 64-byte r||s concatenated form.\\n' +\n        'See https://tools.ietf.org/html/rfc7515#appendix-A.3 for expected ES256 signature form.',\n      ErrorCode.SIGNATURE_FORMAT_ERROR,\n    )\n\n    // DER encoded signature will constructed as follows:\n    // 0       |1             |2      |3         |4-35             |36       |37        |38-69\n    // 0x30      |0x44          |0x02     |0x20        |<r-component of signature> |0x02     |0x20 or 0x21    |<s-component of signature>\n    // Sequence-type |length-of-sequence-data |Integer-type |length-of-integer |integer-data         |Integer-type |length-of-integer |integer-data\n\n    // sigBytes[3] contains length of r-integer it may be 32 or 33 bytes.\n    // DER encoding dictates an Integer is negative if the high-order bit of the first byte is set.\n    //   To represent an integer with a high-order bit as positive, a leading zero byte is required.\n    //   This increases the Integer length to 33.\n\n    // For signature use, the sign is irrelevant and the leading zero, if present, is ignored.\n    const rStart = 4 + (sigBytes[3] - 32) // adjust for the potential leading zero\n    const rBytes = sigBytes.slice(rStart, rStart + 32) // 32 bytes of the r-integer\n    const sStart = sigBytes.length - 32\n    const sBytes = sigBytes.slice(sStart) // 32 bytes of the s-integer\n\n    // Make Base64url\n    const newSig = Buffer.concat([rBytes, sBytes])\n      .toString('base64')\n      .replace(/\\+/g, '-')\n      .replace(/\\//g, '_')\n      .replace(/[=]/g, '')\n    key = newSig\n\n    console.log('jws-signature converted from DER form to r||s form: ' + newSig)\n  } else if (sigBytes && sigBytes.length !== 64) {\n    console.log(\n      'Signature is ' + sigBytes.length.toString() + '-bytes. Signature is expected to be 64-bytes',\n      ErrorCode.SIGNATURE_FORMAT_ERROR,\n    )\n  }\n  return key\n}\n\nfunction checkJwsPayload (rawPayload: string) {\n  // check payload\n  let b64DecodedPayloadBuffer\n  let b64DecodedPayloadString\n\n  try {\n    b64DecodedPayloadBuffer = Buffer.from(rawPayload, 'base64')\n  } catch (err) {\n    console.log(\n      ['Error base64-decoding the JWS payload.', err as string].join('\\n'),\n      ErrorCode.JWS_VERIFICATION_ERROR,\n    )\n  }\n\n  let inflatedPayload\n\n  if (b64DecodedPayloadBuffer) {\n    try {\n      inflatedPayload = pako.inflateRaw(b64DecodedPayloadBuffer, { to: 'string' }).trim()\n    } catch (err) {\n      // try normal inflate\n      try {\n        inflatedPayload = pako.inflate(b64DecodedPayloadBuffer, { to: 'string' }).trim()\n        console.log(\n          'Error inflating JWS payload. Compression should use raw DEFLATE (without wrapper header and adler32 crc)',\n          ErrorCode.INFLATION_ERROR,\n        )\n      } catch (err) {\n        console.log(\n          ['Error inflating JWS payload. Did you use raw DEFLATE compression?', err as string].join(\n            '\\n',\n          ),\n          ErrorCode.INFLATION_ERROR,\n        )\n        // inflating failed, let's try to parse the base64-decoded string directly\n        b64DecodedPayloadString = b64DecodedPayloadBuffer.toString('utf-8').trim()\n      }\n    }\n  }\n  return { inflatedPayload, b64DecodedPayloadString }\n}\n\nasync function extractKeyURL (payload: any) {\n  if (payload.iss) {\n    if (typeof payload.iss === 'string') {\n      if (payload.iss.slice(0, 8) !== 'https://') {\n        console.log('Issuer URL SHALL use https', ErrorCode.INVALID_ISSUER_URL)\n      }\n\n      if (payload.iss.slice(-1) === '/') {\n        console.log('Issuer URL SHALL NOT include a trailing /', ErrorCode.INVALID_ISSUER_URL)\n      }\n      // from issuer data in the vci directory, look for issuer data.\n      var iss= payload.iss\n      var useLegacy = getVerifierInitOption().useLegacy\n      if( ! useLegacy  ) {\n         //switch to canonical_iss if there is \n         var getIssuerFunc = getVerifierInitOption().getIssuer\n         iss = await getIssuerFunc( VerifierKey, payload.iss ) ?? payload.iss\n      }\n      // download the keys into the keystore. if it fails, continue an try to use whatever is in the keystore.\n      if (!JwsValidationOptions.skipJwksDownload) {\n\n        await downloadAndImportValidKeys( iss )\n      } else {\n        console.log('skipping issuer JWK set download')\n      }\n    } else {\n      console.log(`JWS payload 'iss' should be a string, not a ${typeof payload.iss}`)\n    }\n  } else {\n    throw new Error(\"Can't find 'iss' entry in JWS payload\")\n  }\n}\n\nasync function verifyJws (jws: string, kid: string): Promise<boolean> {\n  var key: any | null = null;\n  if (kid && ! ( key = KeysStore.store.get(kid))) {\n    console.log(\n      `JWS verification failed: can't find key with 'kid' = ${kid} in issuer set`,\n      ErrorCode.JWS_VERIFICATION_ERROR,\n    )\n  }\n  if( key && key.error && key.error instanceof InvalidError ) {\n    throw key.error\n  }\n  const verifier: jose.JWS.Verifier = jose.JWS.createVerify(KeysStore.store)\n\n  try {\n    const result = await verifier.verify(jws)\n    return !!result\n\n  } catch (error) {\n    // The error message is always 'no key found', regardless if a key is missing or\n    // if the signature was tempered with. Don't return the node-jose error message.\n    console.log('JWS verification failed', ErrorCode.JWS_VERIFICATION_ERROR)\n    return false\n  }\n}\n"],"mappings":"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"}