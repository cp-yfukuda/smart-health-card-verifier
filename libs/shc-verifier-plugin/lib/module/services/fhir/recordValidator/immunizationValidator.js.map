{"version":3,"names":["ErrorCode","Utils","immunizationDM","patientDM","RecordType","getVerifierInitOption","validate","entries","profileName","immunization","immunizations","filter","entry","resource","resourceType","length","console","log","toString","PROFILE_ERROR","Promise","reject","patients","expectedResources","forEach","index","includes","push","status","toLowerCase","code","vaccineCode","coding","_getCodeFunc","getAcceptedVaccineCodes","cvxCodes","join","constraint","propPath","path","resolve"],"sources":["immunizationValidator.ts"],"sourcesContent":["import { ErrorCode, Utils } from 'verifier-sdk'\nimport immunizationDM from '../../../schemas/immunization-dm.json'\nimport patientDM from '../../../schemas/patient-dm.json'\nimport { RecordType } from '../fhirTypes'\nimport { getVerifierInitOption } from '../../../models/Config'\nimport type { ValidateFunction, BundleEntry } from '../types'\n\nconst validate: ValidateFunction  = async (entries: BundleEntry[])=> {\n  const profileName = RecordType.immunization\n  const immunizations = entries.filter((entry) => entry.resource.resourceType === 'Immunization')\n  if (immunizations.length === 0) {\n    console.log(\n      `Profile : ${profileName} : requires 1 or more Immunization resources. Actual : ${immunizations.length.toString()}`,\n      ErrorCode.PROFILE_ERROR,\n    )\n    return Promise.reject(false)\n  }\n\n  const patients = entries.filter((entry) => entry.resource.resourceType === 'Patient')\n\n  if (patients.length !== 1) {\n    console.log(\n      `Profile : ${profileName} : requires exactly 1 ${'Patient'} resource. Actual : ${patients.length.toString()}`,\n      ErrorCode.PROFILE_ERROR,\n    )\n  }\n\n  const expectedResources = ['Patient', 'Immunization']\n\n  entries.forEach( async (entry, index) => {\n    if (!expectedResources.includes(entry.resource.resourceType)) {\n      console.log(\n        `Profile : ${profileName} : resourceType: ${entry.resource.resourceType} is not allowed.`,\n        ErrorCode.PROFILE_ERROR,\n      )\n      expectedResources.push(entry.resource.resourceType) // prevent duplicates\n      return Promise.reject(false)\n    }\n\n    if (entry.resource.resourceType === 'Immunization') {\n\n      const status = ( entry.resource?.status ?? '' ).toLowerCase()\n      if ( status !== 'completed') {\n        console.log(`Record #${index} has invalid status code: ${status}`) \n      }\n      // verify that valid codes are used see : https://www.cdc.gov/vaccines/programs/iis/COVID-19-related-codes.html\n      const code = (entry.resource?.vaccineCode as { coding: Array<{ code: string }> })?.coding[0]\n        ?.code\n      const _getCodeFunc = getVerifierInitOption().getAcceptedVaccineCodes;\n      const cvxCodes =   _getCodeFunc? await _getCodeFunc(\"shc\"): [];\n\n      if (code && !cvxCodes.includes(code)) {\n        console.log(\n          `Profile : ${profileName} : Immunization.vaccineCode.code ( ${code } ) requires valid COVID-19 code (${cvxCodes.join(\n            ',',\n          )}).`,\n          ErrorCode.PROFILE_ERROR,\n        )\n      }\n\n      // check for properties that are forbidden by the dm-profiles\n      ;(immunizationDM as Array<{ path: string }>).forEach((constraint) => {\n        Utils.propPath(entry.resource, constraint.path) &&\n            console.log(\n              `Profile : ${profileName} : entry[${index.toString()}].resource.${\n                constraint.path\n              } should not be present.`,\n              ErrorCode.PROFILE_ERROR,\n            )\n      })\n    }\n\n    if (entry.resource.resourceType === 'Patient') {\n      // check for properties that are forbidden by the dm-profiles\n      ;(patientDM as Array<{ path: string }>).forEach((constraint) => {\n        Utils.propPath(entry.resource, constraint.path) &&\n            console.log(\n              `Profile : ${profileName} : entry[${index.toString()}].resource.${\n                constraint.path\n              } should not be present.`,\n              ErrorCode.PROFILE_ERROR,\n            )\n      })\n    }\n  })\n\n  return Promise.resolve(true)\n}\n\nexport default validate\n"],"mappings":"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"}