{"version":3,"names":["ErrorCode","Utils","immunizationDM","patientDM","RecordType","getVerifierInitOption","validate","entries","profileName","covid19Immunization","immunizations","filter","entry","resource","resourceType","length","console","log","toString","PROFILE_ERROR","Promise","reject","patients","expectedResources","forEach","index","includes","push","status","toLowerCase","code","vaccineCode","coding","_getCodeFunc","getAcceptedVaccineCodes","cvxCodes","join","constraint","propPath","path","resolve"],"sources":["immunizationValidator.ts"],"sourcesContent":["import { ErrorCode, Utils } from 'verifier-sdk'\nimport immunizationDM from '../../../schemas/immunization-dm.json'\nimport patientDM from '../../../schemas/patient-dm.json'\nimport { RecordType } from '../fhirTypes'\nimport { getVerifierInitOption } from '../../../models/Config'\nimport type { ValidateFunction, BundleEntry } from '../types'\n\nconst validate: ValidateFunction  = async (entries: BundleEntry[])=> {\n  const profileName = RecordType.covid19Immunization\n  const immunizations = entries.filter((entry) => entry.resource.resourceType === 'Immunization')\n  if (immunizations.length === 0) {\n    console.log(\n      `Profile : ${profileName} : requires 1 or more Immunization resources. Actual : ${immunizations.length.toString()}`,\n      ErrorCode.PROFILE_ERROR,\n    )\n    return Promise.reject(false)\n  }\n\n  const patients = entries.filter((entry) => entry.resource.resourceType === 'Patient')\n\n  if (patients.length !== 1) {\n    console.log(\n      `Profile : ${profileName} : requires exactly 1 ${'Patient'} resource. Actual : ${patients.length.toString()}`,\n      ErrorCode.PROFILE_ERROR,\n    )\n  }\n\n  const expectedResources = ['Patient', 'Immunization']\n\n  entries.forEach( async (entry, index) => {\n    if (!expectedResources.includes(entry.resource.resourceType)) {\n      console.log(\n        `Profile : ${profileName} : resourceType: ${entry.resource.resourceType} is not allowed.`,\n        ErrorCode.PROFILE_ERROR,\n      )\n      expectedResources.push(entry.resource.resourceType) // prevent duplicates\n      return Promise.reject(false)\n    }\n\n    if (entry.resource.resourceType === 'Immunization') {\n\n      const status = ( entry.resource?.status ?? '' ).toLowerCase()\n      if ( status !== 'completed') {\n        console.log(`Record #${index} has invalid status code: ${status}`) \n      }\n      // verify that valid codes are used see : https://www.cdc.gov/vaccines/programs/iis/COVID-19-related-codes.html\n      const code = (entry.resource?.vaccineCode as { coding: Array<{ code: string }> })?.coding[0]\n        ?.code\n      const _getCodeFunc = getVerifierInitOption().getAcceptedVaccineCodes;\n      const cvxCodes =   _getCodeFunc? await _getCodeFunc(\"shc\"): [];\n\n      if (code && !cvxCodes.includes(code)) {\n        console.log(\n          `Profile : ${profileName} : Immunization.vaccineCode.code ( ${code } ) requires valid COVID-19 code (${cvxCodes.join(\n            ',',\n          )}).`,\n          ErrorCode.PROFILE_ERROR,\n        )\n      }\n\n      // check for properties that are forbidden by the dm-profiles\n      ;(immunizationDM as Array<{ path: string }>).forEach((constraint) => {\n        Utils.propPath(entry.resource, constraint.path) &&\n            console.log(\n              `Profile : ${profileName} : entry[${index.toString()}].resource.${\n                constraint.path\n              } should not be present.`,\n              ErrorCode.PROFILE_ERROR,\n            )\n      })\n    }\n\n    if (entry.resource.resourceType === 'Patient') {\n      // check for properties that are forbidden by the dm-profiles\n      ;(patientDM as Array<{ path: string }>).forEach((constraint) => {\n        Utils.propPath(entry.resource, constraint.path) &&\n            console.log(\n              `Profile : ${profileName} : entry[${index.toString()}].resource.${\n                constraint.path\n              } should not be present.`,\n              ErrorCode.PROFILE_ERROR,\n            )\n      })\n    }\n  })\n\n  return Promise.resolve(true)\n}\n\nexport default validate\n"],"mappings":"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"}