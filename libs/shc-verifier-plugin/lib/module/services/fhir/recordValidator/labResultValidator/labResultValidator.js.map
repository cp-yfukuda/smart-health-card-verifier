{"version":3,"names":["RecordType","ResourceType","isResourceType","R4Observation","observationValidators","map","cls","validate","entries","profileName","covid19LabResult","patientKeys","labResults","i","length","entry","Patient","fullUrl","push","Observation","observation","find","canSupport","forEach","filter","item","console","log","resource","subject","reference","indexOf","includes","Promise","resolve","info"],"sources":["labResultValidator.ts"],"sourcesContent":["import { RecordType, ResourceType, isResourceType } from '../../fhirTypes'\nimport R4Observation from './versions/R4Observation'\nimport type { ValidateFunction, BundleEntry } from '../../types'\nconst observationValidators= [ R4Observation ].map((cls) => new cls())\n\nconst validate: ValidateFunction = async (entries: BundleEntry[]): Promise<boolean> => {\n  const profileName = RecordType.covid19LabResult\n  /* checks for each entry \n     1. If the type is observation\n     2. if observation can validate the system.\n     3. if case 2, then validate.\n     4. lastly it checks any valid record contains reference to patient\n  */ \n  const patientKeys: String[]  = []\n  let labResults: BundleEntry[] = []\n\n  for( var i=0; i< entries.length; i++ ) \n  {\n    const entry = entries[i];\n    if ( isResourceType( entry, ResourceType.Patient ) && entry.fullUrl ) {\n      patientKeys.push( entry.fullUrl )\n    }\n    if ( isResourceType( entry, ResourceType.Observation )) {\n      /* get the first observation validator */ \n      const observation = observationValidators.find(( observation )=> {\n        return observation.canSupport( entry )\n      }) ?? null\n      if ( observation != null && await observation.validate( entry ) ){\n        labResults.push( entry )\n      } \n    }\n  }\n  entries.forEach( async (entry) => {\n    if ( isResourceType( entry, ResourceType.Patient ) && entry.fullUrl ) {\n      patientKeys.push( entry.fullUrl )\n    }\n    if ( isResourceType( entry, ResourceType.Observation )) {\n      /* get the first observation validator */ \n      const observation = observationValidators.find(( observation )=> {\n        return observation.canSupport( entry )\n      }) ?? null\n      if ( observation != null && await observation.validate( entry ) ){\n        labResults.push( entry )\n      } \n    }\n  })\n\n  /* 4. make sure there is a patient mapped with fullURl */\n  labResults = labResults.filter( (item ) => {\n    console.log('item?.resource?.subject?.reference: ' + item?.resource?.subject?.reference  + '(' + patientKeys.indexOf(item?.resource?.subject?.reference)  + ')')\n    if ( patientKeys.includes(item?.resource?.subject?.reference) ){\n      return true\n    }\n    console.log(`Profile : ${profileName} :  Patient reference does not match`)\n    return false  \n  })\n\n  return Promise.resolve( labResults.length > 0 )\n}\n\nconsole.info('labResultsValidators/labresultValidator' + typeof validate)\nexport default validate\n"],"mappings":"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"}