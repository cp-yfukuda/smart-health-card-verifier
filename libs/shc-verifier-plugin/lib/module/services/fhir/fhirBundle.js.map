{"version":3,"names":["ErrorCode","Utils","InvalidError","validateSchema","objPathToSchema","fhirSchema","getPatientDataFromFhir","getRecordData","getRecordTypeFromPayload","validateBundleForRecordType","VerifierKey","getVerifierInitOption","getIssuerFromFHIR","payload","iss","issuer","getIssuedDateFromFHIR","nbf","res","isNaN","getRecord","issuedDate","notFoundIssuer","message","verifierOption","issuerData","getIssuer","isIssuerNotFound","url","name","undefined","patientData","recordType","tagKeys","getTagKeys","recordEntries","length","NO_VALID_RECORD","document","types","vc","type","tagMap","key","indexOf","push","validate","fhirBundleJSON","isFhirBundleValid","fhirBundle","validateFhirBundle","Promise","reject","index","entry","entries","validateFhirBundleEntry","walkProperties","resource","resourceType","o","path","propType","join","validatePropType","fullUrl","test","console","log","FHIR_SCHEMA_ERROR","Array","CRITICAL_DATA_MISSING","i","toString","definitions","String","id","meta","security","Object","keys","text","display","reference","SCHEMA_ERROR"],"sources":["fhirBundle.ts"],"sourcesContent":["import { ErrorCode, Utils, InvalidError } from 'verifier-sdk'\nimport { validateSchema, objPathToSchema } from '../jws/schema'\nimport fhirSchema from '../../schemas/fhir-schema.json'\nimport { getPatientDataFromFhir } from './getPatiendDataFromFhir'\nimport getRecordData from './recordParser'\n/* this entry needs to match with ValidationProfilesFunctions keys */\nimport { RecordType, getRecordTypeFromPayload } from './fhirTypes'\nimport validateBundleForRecordType from './recordValidator'\nimport { VerifierKey, getVerifierInitOption } from '../../models/Config'\nimport type { JWSPayload, FhirBundle } from './types'\nimport type { BaseResources } from 'verifier-sdk'\n\nconst getIssuerFromFHIR = (payload: any): string => {\n  const { iss: issuer } = payload\n  return issuer\n}\n\nconst getIssuedDateFromFHIR = ( payload: any  ): number | null => {\n  const { nbf: nbf } = payload\n  var res: number | null = null; \n  if( !isNaN(nbf) ) {\n    res = nbf;\n  }\n  return res;\n}\n\nexport async function getRecord (payload: JWSPayload ): Promise<BaseResources>{\n  const issuer = getIssuerFromFHIR(payload)\n  const issuedDate = getIssuedDateFromFHIR( payload );\n  const notFoundIssuer = {\n    message: 'Issuer not found'\n  }\n  const verifierOption = getVerifierInitOption();\n  const issuerData = await verifierOption.getIssuer( VerifierKey, issuer) || notFoundIssuer\n  const { message } = issuerData\n  const isIssuerNotFound = message && message === 'Issuer not found'\n  \n  if (isIssuerNotFound) {\n    issuerData.url = issuer\n    issuerData.name = undefined\n  }\n\n\n  const patientData = getPatientDataFromFhir(payload)\n  const recordType  = getRecordTypeFromPayload(payload)\n  const tagKeys     = getTagKeys(payload)\n  const recordEntries = await getRecordData(recordType, payload)\n  if ( recordEntries?.length === 0 ) {\n    throw new InvalidError(ErrorCode.NO_VALID_RECORD)\n  }\n  const document = {\n    issuedDate,\n    issuerData,\n    patientData,\n    recordType\n  }\n  if( tagKeys ) {\n    document['tagKeys'] = tagKeys\n  }\n  if( recordEntries ) {\n    document['recordEntries'] = recordEntries\n  }\n  return document\n}\n\nexport function getTagKeys( payload: JWSPayload ): string[] {\n  let res:string[] = []\n  let types = payload?.vc?.type || []\n  let tagMap = {\n    \"https://smarthealth.cards#covid19\":\"Covid19\",\n  }\n  for( const key in tagMap){\n    if( types.indexOf(key) >= 0 ) {\n      res.push(tagMap[key])\n    }\n  }\n  return res\n}\n\nexport async function validate ( recordType: RecordType, fhirBundleJSON: object | undefined): Promise<boolean> {\n  let isFhirBundleValid = false\n\n  if ( typeof fhirBundleJSON !== 'undefined') {\n    const fhirBundle = fhirBundleJSON as FhirBundle\n\n    if ( fhirBundle ) {\n      isFhirBundleValid = validateFhirBundle(fhirBundle)\n    }\n    if (!isFhirBundleValid) {\n      return Promise.reject(false)\n    }\n\n    // Validate each resource of .entry[]\n    for (const [index, entry] of fhirBundle.entry.entries()) {\n      validateFhirBundleEntry(entry, index)\n      // walks the property tree of this resource object\n      // the callback receives the child property and it's path objPathToSchema() maps a schema property to a property path\n      // currently, oneOf types will break this system\n      Utils.walkProperties(\n        entry.resource as unknown as Record<string, unknown>,\n        [entry.resource.resourceType],\n        (o: Record<string, unknown>, path: string[]) => {\n          const propType = objPathToSchema(path.join('.'))\n          validatePropType(propType, index, path, o)\n        },\n      )\n\n      // with Bundle.entry.fullUrl populated with short resource-scheme URIs (e.g., {'fullUrl': 'resource:0})\n      if (typeof entry.fullUrl !== 'string' || !/resource:\\d+/.test(entry.fullUrl)) {\n        console.log(\n          'fhirBundle.entry.fullUrl should be short resource-scheme URIs (e.g., {\"fullUrl\": \"resource:0\"}',\n          ErrorCode.FHIR_SCHEMA_ERROR,\n        )\n      }\n    }\n    return validateBundleForRecordType( recordType, fhirBundle )\n      \n  }\n  return false\n}\n\nfunction validateFhirBundle (fhirBundle: FhirBundle) {\n  if (fhirBundle === undefined) {\n    return false\n  }\n\n  // failures will be recorded in the console.log\n  if (!validateSchema(fhirSchema, fhirBundle)) {\n    return false\n  }\n\n  // to continue validation, we must have a list of resources in .entry[]\n  if (!fhirBundle.entry || !(fhirBundle.entry instanceof Array) || fhirBundle.entry.length === 0) {\n    // The schema check above will list the expected properties/type\n    console.log('FhirBundle.entry[] required to continue.', ErrorCode.CRITICAL_DATA_MISSING)\n    return false\n  }\n\n  return true\n}\n\nfunction validateFhirBundleEntry (entry: any, i: number) {\n  const resource = entry.resource\n  if (resource == null) {\n    console.log(`Schema: entry[${i.toString()}].resource missing`)\n  }\n\n  if (!resource.resourceType) {\n    console.log(`Schema: entry[${i.toString()}].resource.resourceType missing`)\n  }\n\n  if (!(fhirSchema.definitions as Record<string, unknown>)[resource.resourceType]) {\n    console.log(\n      `Schema: entry[${i.toString()}].resource.resourceType '${String( resource.resourceType )}' unknown`,\n    )\n  }\n\n  // validateSchema({ $ref: 'https://smarthealth.cards/schema/fhir-schema.json#/definitions/' + resource.resourceType }, resource, ['', 'entry', i.toString(), resource.resourceType].join('/'))\n  if (resource.id) {\n    console.log(\n      `Bundle.entry[${i.toString()}].resource[${String(resource.resourceType)}]\\\n       should not include .id elements`,\n      ErrorCode.FHIR_SCHEMA_ERROR,\n    )\n  }\n\n  if (resource.meta) {\n    // resource.meta.security allowed as special case, however, no other properties may be included on .meta\n    if (!resource.meta.security || Object.keys(resource.meta).length > 1) {\n      console.log(\n        `Bundle.entry[${i.toString()}].resource[${String(resource.resourceType)}].meta \\\n       should only include .security property with an array of identity assurance codes`,\n        ErrorCode.FHIR_SCHEMA_ERROR,\n      )\n    }\n  }\n\n  if (resource.text) {\n    console.log(\n      `Bundle.entry[${i.toString()}].resource[${String(resource.resourceType)}] \\\n         should not include .text elements`,\n      ErrorCode.FHIR_SCHEMA_ERROR,\n    )\n  }\n}\n\nfunction validatePropType (propType: string, i: number, path: string[], o: Record<string, unknown>) {\n  if (propType === 'CodeableConcept' && o.text) {\n    console.log(\n      'fhirBundle.entry[' +\n        i.toString() +\n        ']' +\n        '.resource.' +\n        path.join('.') +\n        ' (CodeableConcept) should not include .text elements',\n      ErrorCode.FHIR_SCHEMA_ERROR,\n    )\n  }\n\n  if (propType === 'Coding' && o.display) {\n    console.log(\n      'fhirBundle.entry[' +\n        i.toString() +\n        ']' +\n        '.resource.' +\n        path.join('.') +\n        ' (Coding) should not include .display elements',\n      ErrorCode.FHIR_SCHEMA_ERROR,\n    )\n  }\n\n  if (propType === 'Reference' && o.reference && !/[^:]+:\\d+/.test(o.reference as string)) {\n    console.log(\n      'fhirBundle.entry[' +\n        i.toString() +\n        ']' +\n        '.resource.' +\n        path.join('.') +\n        ' (Reference) should be short resource-scheme URIs (e.g., {“patient”: {“reference”: “resource:0”}})',\n      ErrorCode.SCHEMA_ERROR,\n    )\n  }\n\n  if (\n    // on empty string, empty object, empty array\n    (o instanceof Array && o.length === 0) ||\n    (typeof o === 'string' && o === '') ||\n    (o instanceof Object && Object.keys(o).length === 0)\n  ) {\n    console.log(\n      'fhirBundle.entry[' +\n        i.toString() +\n        ']' +\n        '.resource.' +\n        path.join('.') +\n        ' is empty. Empty elements are invalid.',\n      ErrorCode.FHIR_SCHEMA_ERROR,\n    )\n  }\n}\n"],"mappings":"AAAA,SAASA,SAAS,EAAEC,KAAK,EAAEC,YAAY,QAAQ,cAAc;AAC7D,SAASC,cAAc,EAAEC,eAAe,QAAQ,eAAe;AAC/D,OAAOC,UAAU,MAAM,gCAAgC;AACvD,SAASC,sBAAsB,QAAQ,0BAA0B;AACjE,OAAOC,aAAa,MAAM,gBAAgB;AAC1C;AACA,SAAqBC,wBAAwB,QAAQ,aAAa;AAClE,OAAOC,2BAA2B,MAAM,mBAAmB;AAC3D,SAASC,WAAW,EAAEC,qBAAqB,QAAQ,qBAAqB;AAIxE,MAAMC,iBAAiB,GAAIC,OAAY,IAAa;EAClD,MAAM;IAAEC,GAAG,EAAEC;EAAO,CAAC,GAAGF,OAAO;EAC/B,OAAOE,MAAM;AACf,CAAC;AAED,MAAMC,qBAAqB,GAAKH,OAAY,IAAsB;EAChE,MAAM;IAAEI,GAAG,EAAEA;EAAI,CAAC,GAAGJ,OAAO;EAC5B,IAAIK,GAAkB,GAAG,IAAI;EAC7B,IAAI,CAACC,KAAK,CAACF,GAAG,CAAC,EAAG;IAChBC,GAAG,GAAGD,GAAG;EACX;EACA,OAAOC,GAAG;AACZ,CAAC;AAED,OAAO,eAAeE,SAAS,CAAEP,OAAmB,EAA0B;EAC5E,MAAME,MAAM,GAAGH,iBAAiB,CAACC,OAAO,CAAC;EACzC,MAAMQ,UAAU,GAAGL,qBAAqB,CAAEH,OAAO,CAAE;EACnD,MAAMS,cAAc,GAAG;IACrBC,OAAO,EAAE;EACX,CAAC;EACD,MAAMC,cAAc,GAAGb,qBAAqB,EAAE;EAC9C,MAAMc,UAAU,GAAG,OAAMD,cAAc,CAACE,SAAS,CAAEhB,WAAW,EAAEK,MAAM,CAAC,KAAIO,cAAc;EACzF,MAAM;IAAEC;EAAQ,CAAC,GAAGE,UAAU;EAC9B,MAAME,gBAAgB,GAAGJ,OAAO,IAAIA,OAAO,KAAK,kBAAkB;EAElE,IAAII,gBAAgB,EAAE;IACpBF,UAAU,CAACG,GAAG,GAAGb,MAAM;IACvBU,UAAU,CAACI,IAAI,GAAGC,SAAS;EAC7B;EAGA,MAAMC,WAAW,GAAGzB,sBAAsB,CAACO,OAAO,CAAC;EACnD,MAAMmB,UAAU,GAAIxB,wBAAwB,CAACK,OAAO,CAAC;EACrD,MAAMoB,OAAO,GAAOC,UAAU,CAACrB,OAAO,CAAC;EACvC,MAAMsB,aAAa,GAAG,MAAM5B,aAAa,CAACyB,UAAU,EAAEnB,OAAO,CAAC;EAC9D,IAAK,CAAAsB,aAAa,aAAbA,aAAa,uBAAbA,aAAa,CAAEC,MAAM,MAAK,CAAC,EAAG;IACjC,MAAM,IAAIlC,YAAY,CAACF,SAAS,CAACqC,eAAe,CAAC;EACnD;EACA,MAAMC,QAAQ,GAAG;IACfjB,UAAU;IACVI,UAAU;IACVM,WAAW;IACXC;EACF,CAAC;EACD,IAAIC,OAAO,EAAG;IACZK,QAAQ,CAAC,SAAS,CAAC,GAAGL,OAAO;EAC/B;EACA,IAAIE,aAAa,EAAG;IAClBG,QAAQ,CAAC,eAAe,CAAC,GAAGH,aAAa;EAC3C;EACA,OAAOG,QAAQ;AACjB;AAEA,OAAO,SAASJ,UAAU,CAAErB,OAAmB,EAAa;EAAA;EAC1D,IAAIK,GAAY,GAAG,EAAE;EACrB,IAAIqB,KAAK,GAAG,CAAA1B,OAAO,aAAPA,OAAO,sCAAPA,OAAO,CAAE2B,EAAE,gDAAX,YAAaC,IAAI,KAAI,EAAE;EACnC,IAAIC,MAAM,GAAG;IACX,mCAAmC,EAAC;EACtC,CAAC;EACD,KAAK,MAAMC,GAAG,IAAID,MAAM,EAAC;IACvB,IAAIH,KAAK,CAACK,OAAO,CAACD,GAAG,CAAC,IAAI,CAAC,EAAG;MAC5BzB,GAAG,CAAC2B,IAAI,CAACH,MAAM,CAACC,GAAG,CAAC,CAAC;IACvB;EACF;EACA,OAAOzB,GAAG;AACZ;AAEA,OAAO,eAAe4B,QAAQ,CAAGd,UAAsB,EAAEe,cAAkC,EAAoB;EAC7G,IAAIC,iBAAiB,GAAG,KAAK;EAE7B,IAAK,OAAOD,cAAc,KAAK,WAAW,EAAE;IAC1C,MAAME,UAAU,GAAGF,cAA4B;IAE/C,IAAKE,UAAU,EAAG;MAChBD,iBAAiB,GAAGE,kBAAkB,CAACD,UAAU,CAAC;IACpD;IACA,IAAI,CAACD,iBAAiB,EAAE;MACtB,OAAOG,OAAO,CAACC,MAAM,CAAC,KAAK,CAAC;IAC9B;;IAEA;IACA,KAAK,MAAM,CAACC,KAAK,EAAEC,KAAK,CAAC,IAAIL,UAAU,CAACK,KAAK,CAACC,OAAO,EAAE,EAAE;MACvDC,uBAAuB,CAACF,KAAK,EAAED,KAAK,CAAC;MACrC;MACA;MACA;MACApD,KAAK,CAACwD,cAAc,CAClBH,KAAK,CAACI,QAAQ,EACd,CAACJ,KAAK,CAACI,QAAQ,CAACC,YAAY,CAAC,EAC7B,CAACC,CAA0B,EAAEC,IAAc,KAAK;QAC9C,MAAMC,QAAQ,GAAG1D,eAAe,CAACyD,IAAI,CAACE,IAAI,CAAC,GAAG,CAAC,CAAC;QAChDC,gBAAgB,CAACF,QAAQ,EAAET,KAAK,EAAEQ,IAAI,EAAED,CAAC,CAAC;MAC5C,CAAC,CACF;;MAED;MACA,IAAI,OAAON,KAAK,CAACW,OAAO,KAAK,QAAQ,IAAI,CAAC,cAAc,CAACC,IAAI,CAACZ,KAAK,CAACW,OAAO,CAAC,EAAE;QAC5EE,OAAO,CAACC,GAAG,CACT,gGAAgG,EAChGpE,SAAS,CAACqE,iBAAiB,CAC5B;MACH;IACF;IACA,OAAO5D,2BAA2B,CAAEuB,UAAU,EAAEiB,UAAU,CAAE;EAE9D;EACA,OAAO,KAAK;AACd;AAEA,SAASC,kBAAkB,CAAED,UAAsB,EAAE;EACnD,IAAIA,UAAU,KAAKnB,SAAS,EAAE;IAC5B,OAAO,KAAK;EACd;;EAEA;EACA,IAAI,CAAC3B,cAAc,CAACE,UAAU,EAAE4C,UAAU,CAAC,EAAE;IAC3C,OAAO,KAAK;EACd;;EAEA;EACA,IAAI,CAACA,UAAU,CAACK,KAAK,IAAI,EAAEL,UAAU,CAACK,KAAK,YAAYgB,KAAK,CAAC,IAAIrB,UAAU,CAACK,KAAK,CAAClB,MAAM,KAAK,CAAC,EAAE;IAC9F;IACA+B,OAAO,CAACC,GAAG,CAAC,0CAA0C,EAAEpE,SAAS,CAACuE,qBAAqB,CAAC;IACxF,OAAO,KAAK;EACd;EAEA,OAAO,IAAI;AACb;AAEA,SAASf,uBAAuB,CAAEF,KAAU,EAAEkB,CAAS,EAAE;EACvD,MAAMd,QAAQ,GAAGJ,KAAK,CAACI,QAAQ;EAC/B,IAAIA,QAAQ,IAAI,IAAI,EAAE;IACpBS,OAAO,CAACC,GAAG,CAAE,iBAAgBI,CAAC,CAACC,QAAQ,EAAG,oBAAmB,CAAC;EAChE;EAEA,IAAI,CAACf,QAAQ,CAACC,YAAY,EAAE;IAC1BQ,OAAO,CAACC,GAAG,CAAE,iBAAgBI,CAAC,CAACC,QAAQ,EAAG,iCAAgC,CAAC;EAC7E;EAEA,IAAI,CAAEpE,UAAU,CAACqE,WAAW,CAA6BhB,QAAQ,CAACC,YAAY,CAAC,EAAE;IAC/EQ,OAAO,CAACC,GAAG,CACR,iBAAgBI,CAAC,CAACC,QAAQ,EAAG,4BAA2BE,MAAM,CAAEjB,QAAQ,CAACC,YAAY,CAAG,WAAU,CACpG;EACH;;EAEA;EACA,IAAID,QAAQ,CAACkB,EAAE,EAAE;IACfT,OAAO,CAACC,GAAG,CACR,gBAAeI,CAAC,CAACC,QAAQ,EAAG,cAAaE,MAAM,CAACjB,QAAQ,CAACC,YAAY,CAAE;AAC9E,uCAAuC,EACjC3D,SAAS,CAACqE,iBAAiB,CAC5B;EACH;EAEA,IAAIX,QAAQ,CAACmB,IAAI,EAAE;IACjB;IACA,IAAI,CAACnB,QAAQ,CAACmB,IAAI,CAACC,QAAQ,IAAIC,MAAM,CAACC,IAAI,CAACtB,QAAQ,CAACmB,IAAI,CAAC,CAACzC,MAAM,GAAG,CAAC,EAAE;MACpE+B,OAAO,CAACC,GAAG,CACR,gBAAeI,CAAC,CAACC,QAAQ,EAAG,cAAaE,MAAM,CAACjB,QAAQ,CAACC,YAAY,CAAE;AAChF,wFAAwF,EAChF3D,SAAS,CAACqE,iBAAiB,CAC5B;IACH;EACF;EAEA,IAAIX,QAAQ,CAACuB,IAAI,EAAE;IACjBd,OAAO,CAACC,GAAG,CACR,gBAAeI,CAAC,CAACC,QAAQ,EAAG,cAAaE,MAAM,CAACjB,QAAQ,CAACC,YAAY,CAAE;AAC9E,2CAA2C,EACrC3D,SAAS,CAACqE,iBAAiB,CAC5B;EACH;AACF;AAEA,SAASL,gBAAgB,CAAEF,QAAgB,EAAEU,CAAS,EAAEX,IAAc,EAAED,CAA0B,EAAE;EAClG,IAAIE,QAAQ,KAAK,iBAAiB,IAAIF,CAAC,CAACqB,IAAI,EAAE;IAC5Cd,OAAO,CAACC,GAAG,CACT,mBAAmB,GACjBI,CAAC,CAACC,QAAQ,EAAE,GACZ,GAAG,GACH,YAAY,GACZZ,IAAI,CAACE,IAAI,CAAC,GAAG,CAAC,GACd,sDAAsD,EACxD/D,SAAS,CAACqE,iBAAiB,CAC5B;EACH;EAEA,IAAIP,QAAQ,KAAK,QAAQ,IAAIF,CAAC,CAACsB,OAAO,EAAE;IACtCf,OAAO,CAACC,GAAG,CACT,mBAAmB,GACjBI,CAAC,CAACC,QAAQ,EAAE,GACZ,GAAG,GACH,YAAY,GACZZ,IAAI,CAACE,IAAI,CAAC,GAAG,CAAC,GACd,gDAAgD,EAClD/D,SAAS,CAACqE,iBAAiB,CAC5B;EACH;EAEA,IAAIP,QAAQ,KAAK,WAAW,IAAIF,CAAC,CAACuB,SAAS,IAAI,CAAC,WAAW,CAACjB,IAAI,CAACN,CAAC,CAACuB,SAAS,CAAW,EAAE;IACvFhB,OAAO,CAACC,GAAG,CACT,mBAAmB,GACjBI,CAAC,CAACC,QAAQ,EAAE,GACZ,GAAG,GACH,YAAY,GACZZ,IAAI,CAACE,IAAI,CAAC,GAAG,CAAC,GACd,oGAAoG,EACtG/D,SAAS,CAACoF,YAAY,CACvB;EACH;EAEA;EACE;EACCxB,CAAC,YAAYU,KAAK,IAAIV,CAAC,CAACxB,MAAM,KAAK,CAAC,IACpC,OAAOwB,CAAC,KAAK,QAAQ,IAAIA,CAAC,KAAK,EAAG,IAClCA,CAAC,YAAYmB,MAAM,IAAIA,MAAM,CAACC,IAAI,CAACpB,CAAC,CAAC,CAACxB,MAAM,KAAK,CAAE,EACpD;IACA+B,OAAO,CAACC,GAAG,CACT,mBAAmB,GACjBI,CAAC,CAACC,QAAQ,EAAE,GACZ,GAAG,GACH,YAAY,GACZZ,IAAI,CAACE,IAAI,CAAC,GAAG,CAAC,GACd,wCAAwC,EAC1C/D,SAAS,CAACqE,iBAAiB,CAC5B;EACH;AACF"}